<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Black Cab Unite v8.1</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#000000">
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-messaging-compat.js"></script>
  <style>
    body { 
      margin:0; 
      font-family:system-ui, -apple-system, "Segoe UI", sans-serif; 
      background:#f7fafc; 
      display:flex; 
      flex-direction:column; 
      height:100vh; 
      overflow:hidden;
    }
    #map { 
      flex:1; 
      width:100%;
      height:100%;
      z-index:1;
    }
    #headerBanner {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      background: #000;
      color: #FFD700;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1001;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    #appTitleContainer {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    #appTitle {
      font-weight: 700;
      font-size: 18px;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }
    #appTitle::before {
      content: "üöï";
      font-size: 20px;
    }
    #statusCaption {
      font-size: 12px;
      color: #FFD700;
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    .status-available .status-dot { background: #28a745; }
    .status-busy .status-dot { background: #ffc107; }
    .status-offline .status-dot { background: #dc3545; }
    #menuBtn {
      background: #FFD700;
      color: #000;
      border: none;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: pointer;
      z-index: 1002;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      transition: transform 0.1s ease;
    }
    #menuBtn:active {
      transform: scale(0.95);
    }
    #passengerPopup {
      display: none;
      position: fixed;
      bottom: 120px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 18px 20px;
      border-radius: 16px;
      font-size: 16px;
      max-width: 300px;
      text-align: center;
      z-index: 3000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    .replyBtn {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      flex: 1;
      margin: 0 4px;
    }
    .replyBtn:nth-child(2) {
      background: #1f6feb;
    }
    #status { 
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 8px 16px;
      border-radius: 24px;
      font-size: 14px;
      color: #333;
      z-index: 1000;
      text-align: center;
      max-width: 90%;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      font-weight: 600;
    }
    .gps-source {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 6px;
    }
    .gps-gps { background: #28a745; }
    .gps-network { background: #17a2b8; }
    .gps-poor { background: #ffc107; }
    #jobPanel { 
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 20px;
      border-top: 2px solid #eee;
      z-index: 1000;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
      display: none;
    }
    #jobPanel h2 { 
      margin: 0 0 16px 0; 
      font-size: 20px; 
      color: #1f6feb;
      text-align: center;
    }
    #jobInfo { 
      background: #f8f9fa;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 24px;
      font-size: 15px;
      line-height: 1.5;
    }
    .job-info-label {
      font-weight: 600;
      color: #495057;
      margin-bottom: 4px;
    }
    .job-info-value {
      font-size: 16px;
      color: #212529;
    }
    #jobTimer {
      margin-top: 12px;
      font-size: 14px;
      color: #dc3545;
      font-weight: bold;
      display: none;
    }
    .job-actions {
      display: flex;
      gap: 16px;
    }
    .job-btn {
      flex: 1;
      padding: 18px 12px;
      font-size: 18px;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      font-weight: 700;
      min-height: 56px;
    }
    .accept-btn {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
    }
    .reject-btn {
      background: linear-gradient(135deg, #dc3545, #e83e8c);
      color: white;
    }
    #micIndicator {
      text-align: center;
      margin: 16px 0;
      display: none;
    }
    .mic-icon {
      width: 48px;
      height: 48px;
      background: #1f6feb;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      box-shadow: 0 0 12px #1f6feb;
      animation: micGlow 1.5s infinite alternate;
    }
    @keyframes micGlow {
      from { box-shadow: 0 0 12px #1f6feb; }
      to { box-shadow: 0 0 24px #1f6feb, 0 0 32px #1f6feb; }
    }
    .mic-label {
      font-size: 13px;
      color: #555;
      margin-top: 8px;
    }
    #loadingOverlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 500;
      color: white;
      font-size: 18px;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top: 4px solid white;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #menuPanel {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 70vh;
      background: white;
      display: none;
      flex-direction: column;
      z-index: 3000;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      transform: translateY(100%);
      transition: transform 0.3s ease;
    }
    #menuPanel.active {
      display: flex;
      transform: translateY(0);
    }
    #menuNav {
      display: flex;
      background: #f8f9fa;
      border-bottom: 1px solid #eee;
    }
    .menu-nav-btn {
      flex: 1;
      background: transparent;
      border: none;
      padding: 16px 0;
      font-weight: 600;
      font-size: 15px;
      color: #666;
      cursor: pointer;
    }
    .menu-nav-btn.active {
      color: #1f6feb;
      background: #e8f0fe;
      border-bottom: 3px solid #1f6feb;
    }
    #menuContent {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    .current-job-info {
      padding: 20px;
      background: #e8f5e8;
      border-radius: 12px;
      margin-bottom: 20px;
      border-left: 4px solid #28a745;
    }
    .job-detail {
      margin-bottom: 12px;
    }
    .job-label {
      font-weight: 700;
      color: #1f6feb;
      font-size: 15px;
      margin-bottom: 4px;
    }
    .job-value {
      font-size: 17px;
      color: #333;
      word-break: break-word;
    }
    .no-current-job {
      text-align: center;
      padding: 50px 20px;
      color: #666;
    }
    .no-current-job .icon {
      font-size: 60px;
      margin-bottom: 20px;
      opacity: 0.7;
    }
    .job-item {
      padding: 16px;
      border: 1px solid #eee;
      border-radius: 12px;
      margin-bottom: 12px;
      background: #f9f9f9;
      position: relative;
      overflow: hidden;
    }
    .job-item.allocated { border-left: 4px solid #28a745; background: #e8f5e8; }
    .job-item.processing, .job-item.bidding { border-left: 4px solid #1f6feb; background: #e8f0fe; }
    .job-item.completed { border-left: 4px solid #6c757d; background: #f8f9fa; }
    .job-item.lost, .job-item.rejected, .job-item.expired { border-left: 4px solid #dc3545; background: #f8d7da; }
    .job-item.queued { border-left: 4px solid #ffc107; background: #fff8e1; }
    .job-id { font-weight: 700; color: #1f6feb; margin-bottom: 6px; font-size: 16px; }
    .job-pub { font-size: 14px; color: #666; margin-bottom: 6px; }
    .job-phone { font-size: 15px; color: #333; margin-bottom: 6px; }
    .job-status {
      font-size: 12px;
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 6px;
    }
    .status-processing, .status-bidding { background: #d1e7ff; color: #084298; }
    .status-allocated { background: #d1e7dd; color: #0f5132; }
    .status-completed { background: #e2e3e5; color: #41464b; }
    .status-lost, .status-rejected, .status-expired { background: #f8d7da; color: #842029; }
    .status-queued { background: #fff3cd; color: #856404; }
    #chatMessages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .message {
      max-width: 85%;
      padding: 14px 16px;
      border-radius: 20px;
      font-size: 15px;
      line-height: 1.5;
      word-wrap: break-word;
    }
    .received { background: #e9ecef; align-self: flex-start; border-bottom-left-radius: 6px; }
    .sent { background: #000; color: white; align-self: flex-end; border-bottom-right-radius: 6px; }
    #chatInputContainer {
      display: flex;
      padding: 12px;
      background: white;
      border-top: 1px solid #eee;
    }
    #chatInput {
      flex: 1;
      padding: 14px;
      border: 2px solid #ddd;
      border-radius: 24px;
      font-size: 16px;
      outline: none;
    }
    #sendBtn {
      background: #000;
      color: #FFD700;
      border: none;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      margin-left: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .settings-group {
      margin-bottom: 24px;
    }
    .settings-label {
      font-weight: 700;
      margin-bottom: 12px;
      color: #333;
      font-size: 16px;
    }
    .settings-input {
      width: 100%;
      padding: 14px;
      border: 2px solid #ccc;
      border-radius: 12px;
      font-size: 16px;
      box-sizing: border-box;
    }
    .settings-input:focus {
      border-color: #1f6feb;
      outline: none;
    }
    .settings-btn {
      background: #1f6feb;
      color: white;
      border: none;
      padding: 16px;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      margin-top: 12px;
      font-size: 16px;
      box-shadow: 0 4px 12px rgba(31, 111, 235, 0.3);
    }
    .settings-btn:hover {
      background: #1958c4;
      box-shadow: 0 6px 16px rgba(31, 111, 235, 0.4);
    }
    /* Job Won Modal */
    #jobWonModal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 2001;
      justify-content: center;
      align-items: center;
    }
    #jobWonModal-content {
      background: white;
      padding: 30px;
      border-radius: 16px;
      text-align: center;
      max-width: 320px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }
    .taxi-marker {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="headerBanner">
    <div id="appTitleContainer">
      <div id="appTitle">Black Cab Unite v8.1</div>
      <div id="statusCaption" class="status-available">
        <span class="status-dot"></span> Available
      </div>
    </div>
    <button id="menuBtn">‚ò∞</button>
  </div>
  <div id="statusDropdown" style="position: absolute; top: 52px; left: 16px; background: white; border: 1px solid #ddd; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1003; display: none; flex-direction: column; min-width: 180px;">
    <div class="status-option" data-status="available" style="padding:12px 16px; cursor:pointer; display:flex; align-items:center; gap:10px;"><span class="status-led" style="background:#28a745; width:12px; height:12px; border-radius:50%;"></span> Available</div>
    <div class="status-option" data-status="busy" style="padding:12px 16px; cursor:pointer; display:flex; align-items:center; gap:10px;"><span class="status-led" style="background:#ffc107; width:12px; height:12px; border-radius:50%;"></span> Busy</div>
    <div class="status-option" data-status="offline" style="padding:12px 16px; cursor:pointer; display:flex; align-items:center; gap:10px;"><span class="status-led" style="background:#dc3545; width:12px; height:12px; border-radius:50%;"></span> Offline</div>
    <div id="logOffBtn" style="padding:12px 16px; cursor:pointer; display:flex; align-items:center; gap:10px; border-top:1px solid #eee; color:#dc3545; font-weight:bold;"><span>üö™</span> Log Off</div>
  </div>
  <div id="status">Initializing...</div>
  <div id="jobPanel">
    <h2>üöï New Job Request</h2>
    <div id="jobInfo">
      <div class="job-info-label">Pickup Location</div>
      <div class="job-info-value" id="pickupLocation">Loading...</div>
      <div class="job-info-label" style="margin-top:12px;">Customer Name</div>
      <div class="job-info-value" id="customerName">Loading...</div>
      <div class="job-info-label" style="margin-top:12px;">Customer Phone</div>
      <div class="job-info-value" id="customerPhone">Loading...</div>
      <div id="jobTimer">‚è≥ Expires in: <span id="timerSeconds">30</span>s</div>
    </div>
    <div id="micIndicator">
      <div class="mic-icon">üé§</div>
      <div class="mic-label">Say ‚Äúaccept‚Äù or ‚Äúreject‚Äù</div>
    </div>
    <div class="job-actions">
      <button class="job-btn accept-btn" id="acceptBtn">‚úÖ ACCEPT JOB</button>
      <button class="job-btn reject-btn" id="rejectBtn">‚ùå REJECT</button>
    </div>
  </div>
  <div id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div>Loading map...</div>
  </div>
  <div id="menuPanel">
    <div id="menuNav">
      <button class="menu-nav-btn active" data-view="currentJob">üìç Current Job</button>
      <button class="menu-nav-btn" data-view="jobHistory">üìã Job History</button>
      <button class="menu-nav-btn" data-view="chat">üí¨ Chats</button>
      <button class="menu-nav-btn" data-view="settings">‚öôÔ∏è Settings</button>
    </div>
    <div id="menuContent"></div>
  </div>
  <div id="jobWonModal">
    <div id="jobWonModal-content">
      <div style="font-size: 60px; margin-bottom: 16px;">üéâ</div>
      <h2 style="margin: 0 0 12px; color: #1f6feb;">You Won the Job!</h2>
      <p style="margin: 0 0 24px; color: #555;">Get ready to pick up the customer.</p>
      <button id="closeJobWonModal" class="settings-btn">Close</button>
    </div>
  </div>
  <div id="passengerPopup">
    <div id="passengerPopupMsg">Passenger message...</div>
    <div style="display:flex; justify-content:center; gap:10px; margin-top:12px;">
      <button id="presetReply1" class="replyBtn">On my way</button>
      <button id="presetReply2" class="replyBtn">Arrived</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBq1aN-KRtRW7S243ef7lz7fnZmlBcuN1s",
      authDomain: "cabunite.firebaseapp.com",
      projectId: "cabunite",
      storageBucket: "cabunite.firebasestorage.app",
      messagingSenderId: "997924656033",
      appId: "1:997924656033:web:1552b9f26a1af0878eb1e0"
    };
    firebase.initializeApp(firebaseConfig);
    const messaging = firebase.messaging();

    messaging.onMessage((payload) => {
      if (Notification.permission === 'granted') {
        new Notification(payload.notification?.title || "Taxi Update", {
          body: payload.notification?.body || "You have a new message",
          icon: '/blackcabunite/icon-192.png'
        });
      }
    });

    // ===== GLOBAL STATE =====
    let fcmToken = null;
    let DRIVER_ID = localStorage.getItem('driver_id');
    let driverPresence = localStorage.getItem('driver_presence') || 'available';
    let seenJobIds = new Set();
    let driverCoords = null;
    let map = null;
    let driverMarker = null;
    let client = null;
    let isMenuOpen = false;
    let currentView = 'currentJob';
    let isJobActive = false;
    let currentJob = null;
    let jobTimerInterval = null;
    let pendingJobs = JSON.parse(localStorage.getItem(`pending_jobs_${DRIVER_ID}`)) || [];
    let driverJobs = JSON.parse(localStorage.getItem(`driver_jobs_${DRIVER_ID}`)) || [];
    let chatMessages = { group: JSON.parse(localStorage.getItem(`chat_group_${DRIVER_ID}`)) || [] };
    let gpsWatchId = null;
    let speechRecognition = null;
    let isSpeaking = false;
    let voiceAttemptCount = 0;
    const MAX_VOICE_ATTEMPTS = 3;
    const TTS_TO_MIC_DELAY_MS = 600;

    seenJobIds = new Set([...driverJobs.map(j => j.job), ...pendingJobs.map(p => p.job)]);

    // ===== VALIDATION =====
    function validateDriverId(id) {
      return id && /^[a-zA-Z0-9_-]+$/.test(id);
    }

    // ===== TTS / STT =====
    function speak(text, onEnd = null) {
      if (!('speechSynthesis' in window)) {
        if (onEnd) setTimeout(onEnd, 100);
        return;
      }
      isSpeaking = true;
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'en-GB';
      u.rate = 0.9;
      u.onend = () => {
        isSpeaking = false;
        if (onEnd) setTimeout(onEnd, TTS_TO_MIC_DELAY_MS);
      };
      speechSynthesis.speak(u);
    }

    function startVoiceListener() {
      if (isSpeaking || speechRecognition) return;
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) return;
      speechRecognition = new SpeechRecognition();
      speechRecognition.lang = 'en-US';
      speechRecognition.continuous = false;
      speechRecognition.interimResults = false;
      speechRecognition.onresult = (e) => {
        const t = e.results[0][0].transcript.toLowerCase();
        if (/\baccept\b/.test(t) && !/\breject\b/.test(t)) {
          voiceAttemptCount = 0;
          respondToJob(true);
          speak("Job accepted. Thank you.");
        } else if (/\breject\b/.test(t)) {
          voiceAttemptCount = 0;
          respondToJob(false);
          speak("Job rejected. Understood.");
        } else {
          voiceAttemptCount++;
          stopVoiceListener();
          promptForVoiceResponse();
        }
        speechRecognition = null;
      };
      speechRecognition.onerror = () => { speechRecognition = null; };
      speechRecognition.onend = () => { speechRecognition = null; };
      try { speechRecognition.start(); } catch (e) {}
    }

    function stopVoiceListener() {
      if (speechRecognition) {
        speechRecognition.abort();
        speechRecognition = null;
      }
    }

    function promptForVoiceResponse() {
      if (isSpeaking || !isJobActive) return;
      // üî• FIX: Always show mic on retry
      document.getElementById('micIndicator').style.display = 'block';
      if (voiceAttemptCount === 0) {
        setTimeout(startVoiceListener, TTS_TO_MIC_DELAY_MS);
      } else if (voiceAttemptCount < MAX_VOICE_ATTEMPTS) {
        speak("Did not hear you. Please say ‚Äòaccept‚Äô or ‚Äòreject‚Äô.", () => {
          document.getElementById('micIndicator').style.display = 'block';
          startVoiceListener();
        });
      } else {
        speak("Let me repeat the job.", () => {
          const job = currentJob;
          if (job) {
            const utterance = new SpeechSynthesisUtterance(
              `Pickup at ${job.pubName}. Customer: ${job.customerName || 'name not given'}. Phone: ${job.customerPhone || 'not provided'}`
            );
            utterance.onend = () => {
              voiceAttemptCount = 0;
              document.getElementById('micIndicator').style.display = 'block';
              setTimeout(promptForVoiceResponse, TTS_TO_MIC_DELAY_MS);
            };
            speechSynthesis.speak(utterance);
          }
        });
      }
    }

    // ===== PASSENGER PRESETS =====
    function handlePassengerPreset(data) {
      const msg = 
        data.presetType === "where_are_you" ? "Passenger asks: Where are you?" :
        data.presetType === "cancel_ride" ? "Passenger wants to cancel the ride." :
        data.presetType === "call_driver" ? "Passenger is trying to call you." :
        `Passenger message: ${data.presetType}`;
      speak(msg);
      showPassengerPopup(msg, data);
    }
    function showPassengerPopup(msg, data) {
      document.getElementById('passengerPopupMsg').textContent = msg;
      document.getElementById('passengerPopup').style.display = 'block';
      setTimeout(() => { document.getElementById('passengerPopup').style.display = 'none'; }, 15000);
      document.getElementById('presetReply1').onclick = () => sendPresetReply('on_my_way', data);
      document.getElementById('presetReply2').onclick = () => sendPresetReply('arrived', data);
    }
    function sendPresetReply(type, data) {
      if (!client) return;
      client.publish('server/preset_replies', JSON.stringify({
        type: 'driver_preset_reply',
        replyType: type,
        driverId: DRIVER_ID,
        jobId: data?.jobId,
        timestamp: Date.now()
      }));
      document.getElementById('passengerPopup').style.display = 'none';
    }

    // ===== STATUS & LOCATION =====
    function setDriverPresence(status) {
      if (!['available', 'busy', 'offline'].includes(status)) return;
      driverPresence = status;
      localStorage.setItem('driver_presence', status);
      const caption = document.getElementById('statusCaption');
      caption.className = `status-${status}`;
      caption.innerHTML = `<span class="status-dot"></span> ${status.charAt(0).toUpperCase() + status.slice(1)}`;
      if (status === 'offline' && gpsWatchId) {
        navigator.geolocation.clearWatch(gpsWatchId);
        gpsWatchId = null;
      } else if (status !== 'offline' && !gpsWatchId) {
        initGPS();
      }
      if (client?.connected) {
        client.publish(`drivers/${DRIVER_ID}/status`, JSON.stringify({
          driver: DRIVER_ID,
          status: status,
          ts: Date.now()
        }));
      }
    }
    function publishLocationThrottled(gpsData) {
      if (!client?.connected) return;
      client.publish(`drivers/${DRIVER_ID}/location`, JSON.stringify({
        driver: DRIVER_ID,
        lat: gpsData.lat,
        lng: gpsData.lng,
        status: driverPresence,
        ts: Date.now(),
        heading: Math.round(gpsData.heading || 0)
      }));
    }

    // ===== FCM =====
    async function requestFCMToken() {
      try {
        const perm = await Notification.requestPermission();
        if (perm !== 'granted') return;
        const reg = await navigator.serviceWorker.register('/blackcabunite/firebase-messaging-sw.js', { scope: '/blackcabunite/' });
        fcmToken = await messaging.getToken({
          vapidKey: "BMl7GKaqVFHFCn3hkjtrgguYUIM87Hfqd4bbN5lzBiWSjUjEFC8ToIi947P3GqyYnZmaHOJtVjwRHcUcCmuLbow",
          serviceWorkerRegistration: reg
        });
        if (fcmToken) publishFcmToken();
      } catch (err) {
        console.error('FCM error:', err);
      }
    }
    function publishFcmToken() {
      if (!client?.connected || !fcmToken || !DRIVER_ID) return;
      client.publish(`drivers/${DRIVER_ID}/fcm`, JSON.stringify({
        driverId: DRIVER_ID,
        fcmToken: fcmToken,
        ts: Date.now()
      }));
    }

    // ===== JOB HANDLING =====
    function respondToJob(accepted) {
      if (!currentJob || !client) return;
      client.publish(`jobs/${currentJob.job}/status`, JSON.stringify({
        job: currentJob.job,
        driver: DRIVER_ID,
        status: accepted ? "bidding" : "rejected",
        lat: driverCoords?.lat || currentJob.lat,
        lng: driverCoords?.lng || currentJob.lng,
        ts: Date.now()
      }));
      if (jobTimerInterval) clearInterval(jobTimerInterval);
      document.getElementById('jobPanel').style.display = 'none';
      isJobActive = false;
      currentJob = null;
      document.getElementById('micIndicator').style.display = 'none';
      speechSynthesis.cancel();
      addJobToHistory(currentJob, accepted ? "bidding" : "rejected");
    }
    function addJobToHistory(jobData, initialStatus = 'queued') {
      if (!jobData) return;
      const job = { ...jobData, status: initialStatus, timestamp: Date.now(), driver: DRIVER_ID };
      driverJobs.unshift(job);
      if (driverJobs.length > 50) driverJobs = driverJobs.slice(0, 50);
      localStorage.setItem(`driver_jobs_${DRIVER_ID}`, JSON.stringify(driverJobs));
      if (isMenuOpen && currentView === 'jobHistory') renderJobHistory();
    }
    function showJobPanel(job) {
      if (seenJobIds.has(job.job)) return;
      seenJobIds.add(job.job);
      isJobActive = true;
      currentJob = job;
      document.getElementById('jobPanel').style.display = 'block';
      document.getElementById('pickupLocation').textContent = `${job.pubName} (${job.lat.toFixed(5)}, ${job.lng.toFixed(5)})`;
      document.getElementById('customerName').textContent = job.customerName || 'Not provided';
      document.getElementById('customerPhone').textContent = job.customerPhone || 'Not provided';
      document.getElementById('jobTimer').style.display = 'block';
      let sec = 30;
      document.getElementById('timerSeconds').textContent = sec;
      jobTimerInterval = setInterval(() => {
        sec--;
        document.getElementById('timerSeconds').textContent = sec;
        if (sec <= 0) {
          clearInterval(jobTimerInterval);
          document.getElementById('jobPanel').style.display = 'none';
          isJobActive = false;
          currentJob = null;
          document.getElementById('micIndicator').style.display = 'none';
        }
      }, 1000);

      // üî• ADD NAVIGATION & CALL BUTTONS
      const navBtn = document.createElement('button');
      navBtn.className = 'settings-btn';
      navBtn.textContent = 'üß≠ Navigate to Pickup';
      navBtn.onclick = () => {
        const url = `https://www.google.com/maps/dir/?api=1&destination=${job.lat},${job.lng}`;
        window.open(url, '_blank');
      };
      const callBtn = document.createElement('button');
      callBtn.className = 'settings-btn';
      callBtn.style.background = '#28a745';
      callBtn.textContent = 'üìû Call Customer';
      callBtn.onclick = () => {
        const phone = job.customerPhone.replace(/\D/g, '');
        if (phone) window.location.href = `tel:${phone}`;
        else alert("Phone not available.");
      };
      const jobInfo = document.getElementById('jobInfo');
      jobInfo.appendChild(navBtn);
      jobInfo.appendChild(callBtn);

      speak(`New job! Pickup at ${job.pubName}. Customer: ${job.customerName || 'name not given'}`, () => {
        promptForVoiceResponse();
      });
    }

    // ===== MENU SYSTEM =====
    function renderCurrentJob() {
      const allocated = driverJobs.find(j => j.status === 'allocated');
      if (!allocated) {
        document.getElementById('menuContent').innerHTML = '<div class="no-current-job"><div class="icon">üöï</div><div>No active job</div></div>';
        return;
      }
      document.getElementById('menuContent').innerHTML = `
        <div class="current-job-info">
          <div class="job-detail"><div class="job-label">Job ID</div><div class="job-value">${allocated.job}</div></div>
          <div class="job-detail"><div class="job-label">Customer</div><div class="job-value">${allocated.customerName}</div></div>
          <div class="job-detail"><div class="job-label">Phone</div><div class="job-value">${allocated.customerPhone}</div></div>
          <div class="job-detail"><div class="job-label">Status</div><div class="job-value"><span class="job-status status-allocated">ALLOCATED</span></div></div>
        </div>
        <button class="settings-btn" onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${allocated.lat},${allocated.lng}', '_blank')">üß≠ Navigate to Pickup</button>
        <button class="settings-btn" style="background:#28a745;" onclick="window.location.href='tel:${allocated.customerPhone.replace(/\\D/g,'')}'">üìû Call Customer</button>
      `;
    }
    function renderJobHistory() {
      const el = document.getElementById('menuContent');
      el.innerHTML = '';
      if (driverJobs.length === 0) {
        el.innerHTML = '<div style="text-align:center;padding:50px;color:#666;">No jobs in history</div>';
        return;
      }
      driverJobs.forEach(job => {
        const jobEl = document.createElement('div');
        jobEl.className = `job-item ${job.status}`;
        jobEl.innerHTML = `
          <div class="job-id">${job.job}</div>
          <div class="job-pub">Pub: ${job.pubName}</div>
          <div class="job-phone">üë§ ${job.customerName || '‚Äî'}</div>
          <div class="job-phone">üìû ${job.customerPhone}</div>
          <div class="job-status status-${job.status}">${job.status}</div>
        `;
        el.appendChild(jobEl);
      });
    }
    function renderChatView() {
      document.getElementById('menuContent').innerHTML = `
        <div id="chatMessages"></div>
        <div id="chatInputContainer">
          <input type="text" id="chatInput" placeholder="Type a message..." />
          <button id="sendBtn">‚û§</button>
        </div>
      `;
      renderChatMessages();
      document.getElementById('sendBtn').addEventListener('click', sendChatMessage);
      document.getElementById('chatInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendChatMessage();
      });
    }
    function renderChatMessages() {
      const el = document.getElementById('chatMessages');
      if (!el) return;
      el.innerHTML = '';
      const msgs = chatMessages.group || [];
      msgs.forEach(msg => {
        const div = document.createElement('div');
        div.className = `message ${msg.sender === DRIVER_ID ? 'sent' : 'received'}`;
        div.textContent = msg.text;
        el.appendChild(div);
      });
      el.scrollTop = el.scrollHeight;
    }
    function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const text = input?.value.trim();
      if (!text || !client) return;
      client.publish('chat/group', JSON.stringify({ sender: DRIVER_ID, text, timestamp: Date.now() }));
      addMessage('group', DRIVER_ID, text);
      input.value = '';
    }
    function addMessage(chatId, sender, text, timestamp = Date.now()) {
      if (!chatMessages[chatId]) chatMessages[chatId] = [];
      chatMessages[chatId].push({ sender, text, timestamp });
      if (chatMessages[chatId].length > 50) {
        chatMessages[chatId] = chatMessages[chatId].slice(-50);
      }
      localStorage.setItem(`chat_group_${DRIVER_ID}`, JSON.stringify(chatMessages.group));
      if (isMenuOpen && currentView === 'chat') renderChatMessages();
    }
    function renderSettingsView() {
      document.getElementById('menuContent').innerHTML = `
        <div class="settings-group">
          <div class="settings-label">Driver ID</div>
          <input type="text" id="driverIdInput" class="settings-input" value="${DRIVER_ID}">
          <button class="settings-btn" id="saveDriverIdBtn">Save Driver ID</button>
        </div>
        <div class="settings-group">
          <button class="settings-btn" id="clearJobsBtn" style="background:#dc3545;">Clear Job History</button>
        </div>
      `;
      document.getElementById('saveDriverIdBtn').addEventListener('click', () => {
        const newId = document.getElementById('driverIdInput').value.trim();
        if (newId && validateDriverId(newId)) {
          localStorage.setItem('driver_id', newId);
          DRIVER_ID = newId;
          alert("Driver ID updated. Reload to apply fully.");
        }
      });
      document.getElementById('clearJobsBtn').addEventListener('click', () => {
        if (confirm("Clear all job history?")) {
          driverJobs = [];
          localStorage.setItem(`driver_jobs_${DRIVER_ID}`, '[]');
          renderJobHistory();
        }
      });
    }
    function renderView(view) {
      currentView = view;
      document.querySelectorAll('.menu-nav-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === view);
      });
      if (view === 'currentJob') renderCurrentJob();
      else if (view === 'jobHistory') renderJobHistory();
      else if (view === 'chat') renderChatView();
      else if (view === 'settings') renderSettingsView();
    }

    // ===== MAP & GPS =====
    const BLACK_CAB_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 58 36" width="58" height="36">
      <rect x="4" y="14" width="50" height="14" rx="3" ry="3" fill="#000"/>
      <path d="M18 14v-4c0-3 2-5 5-5h12c3 0 5 2 5 5v4h-22z" fill="#000"/>
      <rect x="25" y="4" width="8" height="3" rx="1" fill="#FFD700" stroke="#000" stroke-width="0.5"/>
      <text x="29" y="6.6" text-anchor="middle" font-size="2.2" font-weight="bold" fill="#000" font-family="Arial, sans-serif">TAXI</text>
      <rect x="21" y="7" width="6" height="6" rx="1" fill="#fff"/>
      <rect x="31" y="7" width="6" height="6" rx="1" fill="#fff"/>
      <circle cx="15" cy="28" r="4" fill="#fff" stroke="#000" stroke-width="1"/>
      <circle cx="43" cy="28" r="4" fill="#fff" stroke="#000" stroke-width="1"/>
    </svg>`;
    function createBlackCabIcon(heading = 0) {
      const div = document.createElement('div');
      div.innerHTML = BLACK_CAB_SVG;
      const svg = div.firstElementChild;
      svg.style.transform = `rotate(${heading}deg)`;
      return L.divIcon({ html: svg.outerHTML, iconSize: [58, 36], iconAnchor: [29, 18], className: 'taxi-marker' });
    }
    function initMapImmediately() {
      document.getElementById('loadingOverlay').style.display = 'none';
      map = L.map('map').setView([52.4068, -1.5197], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      driverMarker = L.marker([52.4068, -1.5197], {
        title: "Initializing...",
        icon: createBlackCabIcon(0)
      }).addTo(map);
      initGPS();
    }
    function initGPS() {
      if (!('geolocation' in navigator)) {
        document.getElementById('status').innerHTML = '<span class="gps-source gps-poor"></span>Geolocation not supported.';
        connectMQTT();
        return;
      }
      document.getElementById('status').innerHTML = '<span class="gps-source gps-poor"></span>Searching for GPS...';
      if (gpsWatchId) navigator.geolocation.clearWatch(gpsWatchId);
      gpsWatchId = navigator.geolocation.watchPosition(
        pos => {
          const gpsData = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
            accuracy: pos.coords.accuracy || 50,
            heading: pos.coords.heading || 0
          };
          driverCoords = gpsData;
          if (driverMarker) {
            driverMarker.setLatLng([gpsData.lat, gpsData.lng]);
            driverMarker.setIcon(createBlackCabIcon(gpsData.heading));
          }
          publishLocationThrottled(gpsData);
          let cls = 'gps-gps';
          if (gpsData.accuracy > 50) cls = 'gps-poor';
          else if (gpsData.accuracy > 20) cls = 'gps-network';
          document.getElementById('status').innerHTML = `<span class="gps-source ${cls}"></span>GPS active`;
        },
        err => {
          document.getElementById('status').textContent = "GPS error: " + err.message;
        },
        { enableHighAccuracy: true, maximumAge: 0, timeout: 8000 }
      );
      connectMQTT();
    }

    // ===== MQTT =====
    function connectMQTT() {
      client = mqtt.connect("wss://broker.hivemq.com:8884/mqtt", { reconnectPeriod: 1000 });
      client.on('connect', () => {
        document.getElementById('status').textContent = `‚úÖ Connected as ${DRIVER_ID}`;
        client.subscribe("pubs/requests/+");
        client.subscribe(`jobs/+/result/${DRIVER_ID}`); // üëà KEY: Listen for job results
        client.subscribe("drivers/+/location");
        client.subscribe("drivers/+/status");
        client.subscribe("chat/group");
        client.subscribe(`drivers/${DRIVER_ID}/presets`);
        client.publish(`drivers/${DRIVER_ID}/status`, JSON.stringify({ driver: DRIVER_ID, status: driverPresence, ts: Date.now() }));
        publishFcmToken();
        if (driverCoords) publishLocationThrottled(driverCoords);
      });
      client.on('message', (topic, msg) => {
        try {
          const data = JSON.parse(msg.toString());

          // üëá JOB WON HANDLING
          if (topic.startsWith("jobs/") && topic.endsWith(`/result/${DRIVER_ID}`)) {
            const jobId = topic.split('/')[1];
            if (data.result === "won") {
              // Update job status
              const jobIndex = driverJobs.findIndex(j => j.job === jobId);
              if (jobIndex >= 0) driverJobs[jobIndex].status = 'allocated';
              localStorage.setItem(`driver_jobs_${DRIVER_ID}`, JSON.stringify(driverJobs));

              // Show modal + voice
              document.getElementById('jobWonModal').style.display = 'flex';
              speak("Congratulations! You won the job!");

              // Auto-open menu to current job
              if (!isMenuOpen) {
                document.getElementById('menuBtn').click();
              } else {
                renderView('currentJob');
              }
            }
          }

          if (topic === `drivers/${DRIVER_ID}/presets`) {
            handlePassengerPreset(data);
            return;
          }
          if (topic.startsWith("pubs/requests/")) {
            if (!seenJobIds.has(data.job)) {
              pendingJobs.push({ ...data, receivedAt: Date.now() });
              localStorage.setItem(`pending_jobs_${DRIVER_ID}`, JSON.stringify(pendingJobs));
              addJobToHistory(data, 'queued');
              if (driverPresence === 'available' && !isJobActive) {
                showJobPanel(data);
              }
            }
          }
          if (topic === "chat/group") {
            if (data.sender !== DRIVER_ID) {
              addMessage('group', data.sender, data.text, data.timestamp);
            }
          }
        } catch (e) {
          console.error("MQTT error:", e);
        }
      });
    }

    // ===== INIT =====
    function initApp() {
      if (!DRIVER_ID || !validateDriverId(DRIVER_ID)) {
        while (!DRIVER_ID || !validateDriverId(DRIVER_ID)) {
          DRIVER_ID = prompt("Enter your driver ID (letters, numbers, - _):");
          if (DRIVER_ID === null) DRIVER_ID = 'driver-' + Math.random().toString(36).substr(2, 8);
        }
        localStorage.setItem('driver_id', DRIVER_ID);
        driverJobs = JSON.parse(localStorage.getItem(`driver_jobs_${DRIVER_ID}`)) || [];
        pendingJobs = JSON.parse(localStorage.getItem(`pending_jobs_${DRIVER_ID}`)) || [];
        seenJobIds = new Set([...driverJobs.map(j => j.job), ...pendingJobs.map(p => p.job)]);
      }

      const menuPanel = document.getElementById('menuPanel');
      const menuBtn = document.getElementById('menuBtn');

      // ‚úÖ FIXED MENU TOGGLE
      menuBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (isMenuOpen) {
          menuPanel.classList.remove('active');
          isMenuOpen = false;
        } else {
          menuPanel.classList.add('active');
          isMenuOpen = true;
          renderView(currentView);
        }
      });

      document.querySelectorAll('.menu-nav-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          renderView(btn.dataset.view);
        });
      });

      document.getElementById('acceptBtn').addEventListener('click', () => respondToJob(true));
      document.getElementById('rejectBtn').addEventListener('click', () => respondToJob(false));
      document.getElementById('appTitleContainer').addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('statusDropdown').style.display = 
          document.getElementById('statusDropdown').style.display === 'flex' ? 'none' : 'flex';
      });
      document.querySelectorAll('.status-option').forEach(opt => {
        opt.addEventListener('click', () => {
          setDriverPresence(opt.dataset.status);
          document.getElementById('statusDropdown').style.display = 'none';
        });
      });
      document.getElementById('logOffBtn').addEventListener('click', () => setDriverPresence('offline'));
      document.getElementById('closeJobWonModal').addEventListener('click', () => {
        document.getElementById('jobWonModal').style.display = 'none';
      });

      // ‚úÖ FIXED GLOBAL CLICK HANDLER
      document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('statusDropdown');
        if (!dropdown.contains(e.target) && e.target.id !== 'appTitleContainer') {
          dropdown.style.display = 'none';
        }

        const isClickInsideMenu = menuPanel.contains(e.target) || e.target === menuBtn;
        if (isMenuOpen && !isClickInsideMenu) {
          menuPanel.classList.remove('active');
          isMenuOpen = false;
        }
      });

      // Start
      initMapImmediately();
      if ('serviceWorker' in navigator) requestFCMToken();
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initApp);
    } else {
      initApp();
    }
  </script>
</body>
</html>
