<!doctype html>
<html lang="en">
<head>
Â  <meta charset="utf-8" />
Â  <title>Black Cab Unite v7.0</title>
Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
Â  <link rel="manifest" href="./manifest.json">
Â  <meta name="theme-color" content="#000000">
Â  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-messaging-compat.js"></script>
Â  <style>
Â  Â  body {Â 
Â  Â  Â  margin:0;Â 
Â  Â  Â  font-family:system-ui, -apple-system, "Segoe UI", sans-serif;Â 
Â  Â  Â  background:#f7fafc;Â 
Â  Â  Â  display:flex;Â 
Â  Â  Â  flex-direction:column;Â 
Â  Â  Â  height:100vh;Â 
Â  Â  Â  overflow:hidden;
Â  Â  }
Â  Â  #map {Â 
Â  Â  Â  flex:1;Â 
Â  Â  Â  width:100%;
Â  Â  Â  height:100%;
Â  Â  Â  z-index:1;
Â  Â  }
Â  Â  /* Black Cab Unite Header Banner */
Â  Â  #headerBanner {
Â  Â  Â  position: absolute;
Â  Â  Â  top: 0;
Â  Â  Â  left: 0;
Â  Â  Â  right: 0;
Â  Â  Â  background: #000;
Â  Â  Â  color: #FFD700;
Â  Â  Â  padding: 12px 16px;
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  align-items: center;
Â  Â  Â  z-index: 1001;
Â  Â  Â  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
Â  Â  }
Â  Â  #appTitleContainer {
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  align-items: flex-start;
Â  Â  }
Â  Â  #appTitle {
Â  Â  Â  font-weight: 700;
Â  Â  Â  font-size: 18px;
Â  Â  Â  letter-spacing: 0.5px;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 10px;
Â  Â  Â  cursor: pointer;
Â  Â  }
Â  Â  #appTitle::before {
Â  Â  Â  content: "ğŸš•";
Â  Â  Â  font-size: 20px;
Â  Â  }
Â  Â  #statusCaption {
Â  Â  Â  font-size: 12px;
Â  Â  Â  color: #FFD700;
Â  Â  Â  margin-top: 4px;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 4px;
Â  Â  }
Â  Â  .status-dot {
Â  Â  Â  width: 8px;
Â  Â  Â  height: 8px;
Â  Â  Â  border-radius: 50%;
Â  Â  }
Â  Â  .status-available .status-dot { background: #28a745; }
Â  Â  .status-busy .status-dot { background: #ffc107; }
Â  Â  .status-offline .status-dot { background: #dc3545; }
Â  Â  #menuBtn {
Â  Â  Â  background: #FFD700;
Â  Â  Â  color: #000;
Â  Â  Â  border: none;
Â  Â  Â  width: 44px;
Â  Â  Â  height: 44px;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  Â  font-weight: bold;
Â  Â  Â  cursor: pointer;
Â  Â  Â  z-index: 1002;
Â  Â  Â  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
Â  Â  Â  transition: transform 0.1s ease;
Â  Â  }
Â  Â  #menuBtn:active {
Â  Â  Â  transform: scale(0.95);
Â  Â  }
Â  Â  /* === PASSENGER PRESET POPUP === */
Â  Â  #passengerPopup {
Â  Â  Â  display: none;
Â  Â  Â  position: fixed;
Â  Â  Â  bottom: 120px;
Â  Â  Â  left: 50%;
Â  Â  Â  transform: translateX(-50%);
Â  Â  Â  background: rgba(0,0,0,0.85);
Â  Â  Â  color: white;
Â  Â  Â  padding: 18px 20px;
Â  Â  Â  border-radius: 16px;
Â  Â  Â  font-size: 16px;
Â  Â  Â  max-width: 300px;
Â  Â  Â  text-align: center;
Â  Â  Â  z-index: 3000;
Â  Â  Â  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
Â  Â  }
Â  Â  .replyBtn {
Â  Â  Â  background: #28a745;
Â  Â  Â  color: white;
Â  Â  Â  border: none;
Â  Â  Â  padding: 8px 12px;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  font-weight: bold;
Â  Â  Â  cursor: pointer;
Â  Â  Â  flex: 1;
Â  Â  Â  margin: 0 4px;
Â  Â  }
Â  Â  .replyBtn:nth-child(2) {
Â  Â  Â  background: #1f6feb;
Â  Â  }
Â  Â  /* Status bar at bottom */
Â  Â  #status {Â 
Â  Â  Â  position: absolute;
Â  Â  Â  bottom: 80px;
Â  Â  Â  left: 50%;
Â  Â  Â  transform: translateX(-50%);
Â  Â  Â  background: rgba(255, 255, 255, 0.9);
Â  Â  Â  padding: 8px 16px;
Â  Â  Â  border-radius: 24px;
Â  Â  Â  font-size: 14px;
Â  Â  Â  color: #333;
Â  Â  Â  z-index: 1000;
Â  Â  Â  text-align: center;
Â  Â  Â  max-width: 90%;
Â  Â  Â  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
Â  Â  Â  font-weight: 600;
Â  Â  }
Â  Â  .gps-source {
Â  Â  Â  display: inline-block;
Â  Â  Â  width: 12px;
Â  Â  Â  height: 12px;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  margin-right: 6px;
Â  Â  }
Â  Â  .gps-gps { background: #28a745; }
Â  Â  .gps-network { background: #17a2b8; }
Â  Â  .gps-poor { background: #ffc107; }
Â  Â  /* Job panel */
Â  Â  #jobPanel {Â 
Â  Â  Â  position: absolute;
Â  Â  Â  bottom: 0;
Â  Â  Â  left: 0;
Â  Â  Â  right: 0;
Â  Â  Â  background: white;
Â  Â  Â  padding: 20px;
Â  Â  Â  border-top: 2px solid #eee;
Â  Â  Â  z-index: 1000;
Â  Â  Â  box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
Â  Â  Â  display: none;
Â  Â  }
Â  Â  #jobPanel h2 {Â 
Â  Â  Â  margin: 0 0 16px 0;Â 
Â  Â  Â  font-size: 20px;Â 
Â  Â  Â  color: #1f6feb;
Â  Â  Â  text-align: center;
Â  Â  }
Â  Â  #jobInfo {Â 
Â  Â  Â  background: #f8f9fa;
Â  Â  Â  padding: 16px;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  margin-bottom: 24px;
Â  Â  Â  font-size: 15px;
Â  Â  Â  line-height: 1.5;
Â  Â  }
Â  Â  .job-info-label {
Â  Â  Â  font-weight: 600;
Â  Â  Â  color: #495057;
Â  Â  Â  margin-bottom: 4px;
Â  Â  }
Â  Â  .job-info-value {
Â  Â  Â  font-size: 16px;
Â  Â  Â  color: #212529;
Â  Â  }
Â  Â  #jobTimer {
Â  Â  Â  margin-top: 12px;
Â  Â  Â  font-size: 14px;
Â  Â  Â  color: #dc3545;
Â  Â  Â  font-weight: bold;
Â  Â  Â  display: none;
Â  Â  }
Â  Â  .job-actions {
Â  Â  Â  display: flex;
Â  Â  Â  gap: 16px;
Â  Â  }
Â  Â  .job-btn {
Â  Â  Â  flex: 1;
Â  Â  Â  padding: 18px 12px;
Â  Â  Â  font-size: 18px;
Â  Â  Â  border: none;
Â  Â  Â  border-radius: 16px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-weight: 700;
Â  Â  Â  min-height: 56px;
Â  Â  }
Â  Â  .accept-btn {
Â  Â  Â  background: linear-gradient(135deg, #28a745, #20c997);
Â  Â  Â  color: white;
Â  Â  }
Â  Â  .reject-btn {
Â  Â  Â  background: linear-gradient(135deg, #dc3545, #e83e8c);
Â  Â  Â  color: white;
Â  Â  }
Â  Â  /* Glowing Mic Indicator */
Â  Â  #micIndicator {
Â  Â  Â  text-align: center;
Â  Â  Â  margin: 16px 0;
Â  Â  Â  display: none;
Â  Â  }
Â  Â  .mic-icon {
Â  Â  Â  width: 48px;
Â  Â  Â  height: 48px;
Â  Â  Â  background: #1f6feb;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  Â  color: white;
Â  Â  Â  font-weight: bold;
Â  Â  Â  box-shadow: 0 0 12px #1f6feb;
Â  Â  Â  animation: micGlow 1.5s infinite alternate;
Â  Â  }
Â  Â  @keyframes micGlow {
Â  Â  Â  from { box-shadow: 0 0 12px #1f6feb; }
Â  Â  Â  to { box-shadow: 0 0 24px #1f6feb, 0 0 32px #1f6feb; }
Â  Â  }
Â  Â  .mic-label {
Â  Â  Â  font-size: 13px;
Â  Â  Â  color: #555;
Â  Â  Â  margin-top: 8px;
Â  Â  }
Â  Â  /* Driver icons */
Â  Â  .other-driver-icon {
Â  Â  Â  width: 32px;
Â  Â  Â  height: 32px;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  Â  color: white;
Â  Â  Â  font-weight: bold;
Â  Â  Â  font-size: 10px;
Â  Â  Â  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
Â  Â  }
Â  Â  /* Loading overlay */
Â  Â  #loadingOverlay {
Â  Â  Â  position: absolute;
Â  Â  Â  top: 0;
Â  Â  Â  left: 0;
Â  Â  Â  right: 0;
Â  Â  Â  bottom: 0;
Â  Â  Â  background: rgba(0,0,0,0.7);
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  justify-content: center;
Â  Â  Â  align-items: center;
Â  Â  Â  z-index: 500;
Â  Â  Â  color: white;
Â  Â  Â  font-size: 18px;
Â  Â  }
Â  Â  .loading-spinner {
Â  Â  Â  width: 40px;
Â  Â  Â  height: 40px;
Â  Â  Â  border: 4px solid rgba(255,255,255,0.3);
Â  Â  Â  border-radius: 50%;
Â  Â  Â  border-top: 4px solid white;
Â  Â  Â  animation: spin 1s linear infinite;
Â  Â  Â  margin-bottom: 16px;
Â  Â  }
Â  Â  @keyframes spin {
Â  Â  Â  0% { transform: rotate(0deg); }
Â  Â  Â  100% { transform: rotate(360deg); }
Â  Â  }
Â  Â  /* Main Menu Panel */
Â  Â  #menuPanel {
Â  Â  Â  position: absolute;
Â  Â  Â  bottom: 0;
Â  Â  Â  left: 0;
Â  Â  Â  right: 0;
Â  Â  Â  height: 70vh;
Â  Â  Â  background: white;
Â  Â  Â  display: none;
Â  Â  Â  flex-direction: column;
Â  Â  Â  z-index: 2000;
Â  Â  Â  box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
Â  Â  Â  transform: translateY(100%);
Â  Â  Â  transition: transform 0.3s ease;
Â  Â  }
Â  Â  #menuPanel.active {
Â  Â  Â  display: flex;
Â  Â  Â  transform: translateY(0);
Â  Â  }
Â  Â  #menuNav {
Â  Â  Â  display: flex;
Â  Â  Â  background: #f8f9fa;
Â  Â  Â  border-bottom: 1px solid #eee;
Â  Â  }
Â  Â  .menu-nav-btn {
Â  Â  Â  flex: 1;
Â  Â  Â  background: transparent;
Â  Â  Â  border: none;
Â  Â  Â  padding: 16px 0;
Â  Â  Â  font-weight: 600;
Â  Â  Â  font-size: 15px;
Â  Â  Â  color: #666;
Â  Â  Â  cursor: pointer;
Â  Â  }
Â  Â  .menu-nav-btn.active {
Â  Â  Â  color: #1f6feb;
Â  Â  Â  background: #e8f0fe;
Â  Â  Â  border-bottom: 3px solid #1f6feb;
Â  Â  }
Â  Â  #menuContent {
Â  Â  Â  flex: 1;
Â  Â  Â  overflow-y: auto;
Â  Â  Â  padding: 20px;
Â  Â  }
Â  Â  .current-job-info {
Â  Â  Â  padding: 20px;
Â  Â  Â  background: #e8f5e8;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  border-left: 4px solid #28a745;
Â  Â  }
Â  Â  .job-detail {
Â  Â  Â  margin-bottom: 12px;
Â  Â  }
Â  Â  .job-label {
Â  Â  Â  font-weight: 700;
Â  Â  Â  color: #1f6feb;
Â  Â  Â  font-size: 15px;
Â  Â  Â  margin-bottom: 4px;
Â  Â  }
Â  Â  .job-value {
Â  Â  Â  font-size: 17px;
Â  Â  Â  color: #333;
Â  Â  Â  word-break: break-word;
Â  Â  }
Â  Â  .no-current-job {
Â  Â  Â  text-align: center;
Â  Â  Â  padding: 50px 20px;
Â  Â  Â  color: #666;
Â  Â  }
Â  Â  .no-current-job .icon {
Â  Â  Â  font-size: 60px;
Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  opacity: 0.7;
Â  Â  }
Â  Â  .job-item {
Â  Â  Â  padding: 16px;
Â  Â  Â  border: 1px solid #eee;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  margin-bottom: 12px;
Â  Â  Â  background: #f9f9f9;
Â  Â  Â  position: relative;
Â  Â  Â  overflow: hidden;
Â  Â  }
Â  Â  .job-item.allocated { border-left: 4px solid #28a745; background: #e8f5e8; }
Â  Â  .job-item.processing, .job-item.bidding { border-left: 4px solid #1f6feb; background: #e8f0fe; }
Â  Â  .job-item.completed { border-left: 4px solid #6c757d; background: #f8f9fa; }
Â  Â  .job-item.lost, .job-item.rejected, .job-item.expired { border-left: 4px solid #dc3545; background: #f8d7da; }
Â  Â  .job-item.queued { border-left: 4px solid #ffc107; background: #fff8e1; }
Â  Â  .job-id { font-weight: 700; color: #1f6feb; margin-bottom: 6px; font-size: 16px; }
Â  Â  .job-pub { font-size: 14px; color: #666; margin-bottom: 6px; }
Â  Â  .job-phone { font-size: 15px; color: #333; margin-bottom: 6px; }
Â  Â  .job-status {
Â  Â  Â  font-size: 12px;
Â  Â  Â  font-weight: 700;
Â  Â  Â  padding: 4px 8px;
Â  Â  Â  border-radius: 6px;
Â  Â  }
Â  Â  .status-processing, .status-bidding { background: #d1e7ff; color: #084298; }
Â  Â  .status-allocated { background: #d1e7dd; color: #0f5132; }
Â  Â  .status-completed { background: #e2e3e5; color: #41464b; }
Â  Â  .status-lost, .status-rejected, .status-expired { background: #f8d7da; color: #842029; }
Â  Â  .status-queued { background: #fff3cd; color: #856404; }
Â  Â  /* Swipe-to-delete with trash icon */
Â  Â  .job-item::after {
Â  Â  Â  content: "ğŸ—‘ï¸";
Â  Â  Â  position: absolute;
Â  Â  Â  right: 16px;
Â  Â  Â  top: 50%;
Â  Â  Â  transform: translateY(-50%);
Â  Â  Â  background: #dc3545;
Â  Â  Â  color: white;
Â  Â  Â  width: 36px;
Â  Â  Â  height: 36px;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  Â  font-size: 18px;
Â  Â  Â  opacity: 0;
Â  Â  Â  pointer-events: none;
Â  Â  Â  transition: opacity 0.2s ease;
Â  Â  Â  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
Â  Â  }
Â  Â  .job-item.swiping::after {
Â  Â  Â  opacity: 1;
Â  Â  }
Â  Â  #chatMessages {
Â  Â  Â  flex: 1;
Â  Â  Â  padding: 16px;
Â  Â  Â  overflow-y: auto;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  gap: 12px;
Â  Â  }
Â  Â  .message {
Â  Â  Â  max-width: 85%;
Â  Â  Â  padding: 14px 16px;
Â  Â  Â  border-radius: 20px;
Â  Â  Â  font-size: 15px;
Â  Â  Â  line-height: 1.5;
Â  Â  Â  word-wrap: break-word;
Â  Â  }
Â  Â  .received { background: #e9ecef; align-self: flex-start; border-bottom-left-radius: 6px; }
Â  Â  .sent { background: #000; color: white; align-self: flex-end; border-bottom-right-radius: 6px; }
Â  Â  .message-info {
Â  Â  Â  font-size: 12px;
Â  Â  Â  opacity: 0.8;
Â  Â  Â  margin-top: 6px;
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-between;
Â  Â  }
Â  Â  #chatInputContainer {
Â  Â  Â  display: flex;
Â  Â  Â  padding: 12px;
Â  Â  Â  background: white;
Â  Â  Â  border-top: 1px solid #eee;
Â  Â  }
Â  Â  #chatInput {
Â  Â  Â  flex: 1;
Â  Â  Â  padding: 14px;
Â  Â  Â  border: 2px solid #ddd;
Â  Â  Â  border-radius: 24px;
Â  Â  Â  font-size: 16px;
Â  Â  Â  outline: none;
Â  Â  }
Â  Â  #chatInput:focus {
Â  Â  Â  border-color: #1f6feb;
Â  Â  Â  box-shadow: 0 0 0 3px rgba(31, 111, 235, 0.2);
Â  Â  }
Â  Â  #sendBtn {
Â  Â  Â  background: #000;
Â  Â  Â  color: #FFD700;
Â  Â  Â  border: none;
Â  Â  Â  width: 52px;
Â  Â  Â  height: 52px;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  margin-left: 12px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  Â  font-weight: bold;
Â  Â  Â  font-size: 20px;
Â  Â  Â  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
Â  Â  }
Â  Â  #chatList {
Â  Â  Â  flex: 1;
Â  Â  Â  overflow-y: auto;
Â  Â  Â  padding: 8px;
Â  Â  }
Â  Â  .contact-item {
Â  Â  Â  padding: 16px;
Â  Â  Â  border-bottom: 1px solid #eee;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 16px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  transition: background 0.2s;
Â  Â  }
Â  Â  .contact-item:hover {
Â  Â  Â  background: #f8f9fa;
Â  Â  }
Â  Â  .contact-name {
Â  Â  Â  font-weight: 700;
Â  Â  Â  font-size: 16px;
Â  Â  Â  margin-bottom: 4px;
Â  Â  }
Â  Â  .contact-status {
Â  Â  Â  font-size: 13px;
Â  Â  Â  color: #6c757d;
Â  Â  }
Â  Â  .contact-badge {
Â  Â  Â  background: #28a745;
Â  Â  Â  width: 12px;
Â  Â  Â  height: 12px;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  margin-left: auto;
Â  Â  }
Â  Â  .offline { background: #6c757d; }
Â  Â  .unread-badge {
Â  Â  Â  background: #FFD700;
Â  Â  Â  color: #000;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  padding: 4px 8px;
Â  Â  Â  font-size: 12px;
Â  Â  Â  margin-left: 8px;
Â  Â  Â  font-weight: 700;
Â  Â  }
Â  Â  .settings-group {
Â  Â  Â  margin-bottom: 24px;
Â  Â  }
Â  Â  .settings-label {
Â  Â  Â  font-weight: 700;
Â  Â  Â  margin-bottom: 12px;
Â  Â  Â  color: #333;
Â  Â  Â  font-size: 16px;
Â  Â  }
Â  Â  .settings-input {
Â  Â  Â  width: 100%;
Â  Â  Â  padding: 14px;
Â  Â  Â  border: 2px solid #ccc;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  font-size: 16px;
Â  Â  Â  box-sizing: border-box;
Â  Â  }
Â  Â  .settings-input:focus {
Â  Â  Â  border-color: #1f6feb;
Â  Â  Â  outline: none;
Â  Â  }
Â  Â  .settings-btn {
Â  Â  Â  background: #1f6feb;
Â  Â  Â  color: white;
Â  Â  Â  border: none;
Â  Â  Â  padding: 16px;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  font-weight: 700;
Â  Â  Â  cursor: pointer;
Â  Â  Â  width: 100%;
Â  Â  Â  margin-top: 12px;
Â  Â  Â  font-size: 16px;
Â  Â  Â  box-shadow: 0 4px 12px rgba(31, 111, 235, 0.3);
Â  Â  }
Â  Â  .settings-btn:hover {
Â  Â  Â  background: #1958c4;
Â  Â  Â  box-shadow: 0 6px 16px rgba(31, 111, 235, 0.4);
Â  Â  }
Â  Â  .settings-info {
Â  Â  Â  background: #f8f9fa;
Â  Â  Â  padding: 16px;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  font-size: 14px;
Â  Â  Â  color: #666;
Â  Â  Â  line-height: 1.5;
Â  Â  }
Â  Â  /* Enhanced Taxi Marker */
Â  Â  .taxi-marker {
Â  Â  Â  background: transparent !important;
Â  Â  Â  border: none !important;
Â  Â  Â  box-shadow: none !important;
Â  Â  }
Â  </style>
</head>
<body>
Â  <div id="map"></div>
Â  <div id="headerBanner">
Â  Â  <div id="appTitleContainer">
Â  Â  Â  <div id="appTitle">Black Cab Unite v7.0</div>
Â  Â  Â  <div id="statusCaption" class="status-offline">
Â  Â  Â  Â  <span class="status-dot"></span> Offline
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <button id="menuBtn">â˜°</button>
Â  </div>
Â  Â  <div id="statusDropdown" style="
Â  Â  position: absolute;
Â  Â  top: 52px;
Â  Â  left: 16px;
Â  Â  background: white;
Â  Â  border: 1px solid #ddd;
Â  Â  border-radius: 12px;
Â  Â  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
Â  Â  z-index: 1003;
Â  Â  display: none;
Â  Â  flex-direction: column;
Â  Â  min-width: 180px;
Â  ">
Â  Â  <div class="status-option" data-status="available" style="padding:12px 16px; cursor:pointer; display:flex; align-items:center; gap:10px;">
Â  Â  Â  <span class="status-led" style="background:#28a745; width:12px; height:12px; border-radius:50%;"></span> Available
Â  Â  </div>
Â  Â  <div class="status-option" data-status="busy" style="padding:12px 16px; cursor:pointer; display:flex; align-items:center; gap:10px;">
Â  Â  Â  <span class="status-led" style="background:#ffc107; width:12px; height:12px; border-radius:50%;"></span> Busy
Â  Â  </div>
Â  Â  <div class="status-option" data-status="offline" style="padding:12px 16px; cursor:pointer; display:flex; align-items:center; gap:10px;">
Â  Â  Â  <span class="status-led" style="background:#dc3545; width:12px; height:12px; border-radius:50%;"></span> Offline
Â  Â  </div>
Â  Â  <div id="logOffBtn" style="padding:12px 16px; cursor:pointer; display:flex; align-items:center; gap:10px; border-top:1px solid #eee; color:#dc3545; font-weight:bold;">
Â  Â  Â  <span>ğŸšª</span> Log Off
Â  Â  </div>
Â  </div>
Â  <div id="status">Initializing...</div>
Â  <div id="jobPanel">
Â  Â  <h2>ğŸš• New Job Request</h2>
Â  Â  <div id="jobInfo">
Â  Â  Â  <div class="job-info-label">Pickup Location</div>
Â  Â  Â  <div class="job-info-value" id="pickupLocation">Loading...</div>
Â  Â  Â  <div class="job-info-label" style="margin-top:12px;">Customer Name</div>
Â  Â  Â  <div class="job-info-value" id="customerName">Loading...</div>
Â  Â  Â  <div class="job-info-label" style="margin-top:12px;">Customer Phone</div>
Â  Â  Â  <div class="job-info-value" id="customerPhone">Loading...</div>
Â  Â  Â  <div id="jobTimer">â³ Expires in: <span id="timerSeconds">30</span>s</div>
Â  Â  </div>
Â  Â  <div id="micIndicator">
Â  Â  Â  <div class="mic-icon">ğŸ¤</div>
Â  Â  Â  <div class="mic-label">Say â€œacceptâ€ or â€œrejectâ€</div>
Â  Â  </div>
Â  Â  <div class="job-actions">
Â  Â  Â  <button class="job-btn accept-btn" id="acceptBtn">âœ… ACCEPT JOB</button>
Â  Â  Â  <button class="job-btn reject-btn" id="rejectBtn">âŒ REJECT</button>
Â  Â  </div>
Â  </div>
Â  <div id="loadingOverlay">
Â  Â  <div class="loading-spinner"></div>
Â  Â  <div>Loading map...</div>
Â  </div>
Â  <div id="menuPanel">
Â  Â  <div id="menuNav">
Â  Â  Â  <button class="menu-nav-btn active" data-view="currentJob">ğŸ“ Current Job</button>
Â  Â  Â  <button class="menu-nav-btn" data-view="jobHistory">ğŸ“‹ Job History</button>
Â  Â  Â  <button class="menu-nav-btn" data-view="chat">ğŸ’¬ Chats</button>
Â  Â  Â  <button class="menu-nav-btn" data-view="settings">âš™ï¸ Settings</button>
Â  Â  </div>
Â  Â  <div id="menuContent"></div>
Â  </div>
Â  <div id="jobWonModal" style="
Â  Â  display: none;
Â  Â  position: fixed;
Â  Â  top: 0; left: 0; right: 0; bottom: 0;
Â  Â  background: rgba(0,0,0,0.7);
Â  Â  z-index: 2000;
Â  Â  justify-content: center;
Â  Â  align-items: center;
Â  ">
Â  Â  <div style="
Â  Â  Â  background: white;
Â  Â  Â  padding: 30px;
Â  Â  Â  border-radius: 16px;
Â  Â  Â  text-align: center;
Â  Â  Â  max-width: 320px;
Â  Â  Â  box-shadow: 0 8px 24px rgba(0,0,0,0.3);
Â  Â  ">
Â  Â  Â  <div style="font-size: 60px; margin-bottom: 16px;">ğŸ‰</div>
Â  Â  Â  <h2 style="margin: 0 0 12px; color: #1f6feb;">You Won the Job!</h2>
Â  Â  Â  <p style="margin: 0 0 24px; color: #555;">Get ready to pick up the customer.</p>
Â  Â  Â  <button id="closeJobWonModal" style="
Â  Â  Â  Â  background: #1f6feb;
Â  Â  Â  Â  color: white;
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  padding: 12px 24px;
Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  ">Close</button>
Â  Â  </div>
Â  </div>
Â  Â  <div id="passengerPopup">
Â  Â  <div id="passengerPopupMsg">Passenger message...</div>
Â  Â  <div style="display:flex; justify-content:center; gap:10px; margin-top:12px;">
Â  Â  Â  <button id="presetReply1" class="replyBtn">On my way</button>
Â  Â  Â  <button id="presetReply2" class="replyBtn">Arrived</button>
Â  Â  </div>
Â  </div>

Â  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
Â  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
Â  <script>
Â  Â  // ===== FIREBASE INIT =====
Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyBq1aN-KRtRW7S243ef7lz7fnZmlBcuN1s",
Â  Â  Â  authDomain: "cabunite.firebaseapp.com",
Â  Â  Â  projectId: "cabunite",
Â  Â  Â  storageBucket: "cabunite.firebasestorage.app",
Â  Â  Â  messagingSenderId: "997924656033",
Â  Â  Â  appId: "1:997924656033:web:1552b9f26a1af0878eb1e0"
Â  Â  };
Â  Â  firebase.initializeApp(firebaseConfig);
Â  Â  const messaging = firebase.messaging();

Â  Â  messaging.onMessage((payload) => {
Â  Â  Â  console.log("ğŸ“² Foreground message received:", payload);
Â  Â  Â  if (Notification.permission === 'granted') {
Â  Â  Â  Â  new Notification(payload.notification?.title || "Taxi Update", {
Â  Â  Â  Â  Â  body: payload.notification?.body || "You have a new message",
Â  Â  Â  Â  Â  icon: payload.notification?.icon || '/blackcabunite/icon-192.png'
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  });

Â  Â  // ===== GLOBAL STATE =====
Â  Â  let fcmToken = null;
Â  Â  let DRIVER_ID = localStorage.getItem('driver_id');
Â  Â  let driverPresence = localStorage.getItem('driver_presence') || 'offline'; // Changed default to offline
Â  Â  let seenJobIds = new Set();
Â  Â  let ttsInitialized = false;
Â  Â  let driverCoords = null;
Â  Â  let map = null;
Â  Â  let driverMarker = null;
Â  Â  let pickupMarker = null;
Â  Â  let routeLine = null;
Â  Â  let client = null;
Â  Â  let isMenuOpen = false;
Â  Â  let currentView = 'currentJob';
Â  Â  let gpsWatchId = null;
Â  Â  const otherDrivers = {};
Â  Â  const otherDriverMarkers = {}; // New object for other driver markers
Â  Â  const chatMessages = { group: JSON.parse(localStorage.getItem(`chat_group_${DRIVER_ID}`)) || [] };
Â  Â  const unreadCounts = { group: 0 };
Â  Â  let maxRadius = parseFloat(localStorage.getItem('max_radius_km') || '10');
Â  Â  let isJobActive = false;
Â  Â  let currentChat = 'group';
Â  Â  let jobTimerInterval = null;
Â  Â  let currentJob = null;
Â  Â  let pendingJobs = JSON.parse(localStorage.getItem(`pending_jobs_${DRIVER_ID}`)) || [];
Â  Â  let driverJobs = JSON.parse(localStorage.getItem(`driver_jobs_${DRIVER_ID}`)) || [];

Â  Â  // Initialize seenJobIds
Â  Â  seenJobIds = new Set([...driverJobs.map(j => j.job), ...pendingJobs.map(p => p.job)]);
Â  Â  const MQTT_BROKER = "wss://broker.hivemq.com:8884/mqtt";
Â  Â  const VAPID_KEY = "BMl7GKaqVFHFCn3hkjtrgguYUIM87Hfqd4bbN5lzBiWSjUjEFC8ToIi947P3GqyYnZmaHOJtVjwRHcUcCmuLbow";

Â  Â  // ===== VALIDATE DRIVER ID (Initial setup) =====
Â  Â  function validateDriverId(id) {
Â  Â  Â  if (!id) return false;
Â  Â  Â  return /^[a-zA-Z0-9_-]+$/.test(id);
Â  Â  }

Â  Â  if (!DRIVER_ID || !validateDriverId(DRIVER_ID)) {
Â  Â  Â  while (!DRIVER_ID || !validateDriverId(DRIVER_ID)) {
Â  Â  Â  Â  DRIVER_ID = prompt("Enter your driver name or ID (letters, numbers, hyphens only):");
Â  Â  Â  Â  if (DRIVER_ID === null) {
Â  Â  Â  Â  Â  DRIVER_ID = 'driver-' + Math.random().toString(36).substr(2, 8);
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  localStorage.setItem('driver_id', DRIVER_ID);
Â  Â  }

Â  Â  driverJobs = JSON.parse(localStorage.getItem(`driver_jobs_${DRIVER_ID}`)) || [];
Â  Â  pendingJobs = JSON.parse(localStorage.getItem(`pending_jobs_${DRIVER_ID}`)) || [];
Â  Â  chatMessages.group = JSON.parse(localStorage.getItem(`chat_group_${DRIVER_ID}`)) || [];
Â  Â  seenJobIds = new Set([...driverJobs.map(j => j.job), ...pendingJobs.map(p => p.job)]);

Â  Â  // ===== GLOBAL DOM REFERENCES =====
Â  Â  const statusEl = document.getElementById('status');
Â  Â  const jobPanel = document.getElementById('jobPanel');
Â  Â  const pickupLocation = document.getElementById('pickupLocation');
Â  Â  const customerName = document.getElementById('customerName');
Â  Â  const customerPhone = document.getElementById('customerPhone');
Â  Â  const menuPanel = document.getElementById('menuPanel');
Â  Â  const menuContent = document.getElementById('menuContent');
Â  Â  const menuNavBtns = document.querySelectorAll('.menu-nav-btn');
Â  Â  const loadingOverlay = document.getElementById('loadingOverlay');
Â  Â  const micIndicator = document.getElementById('micIndicator');

Â  Â  // ===== INIT TTS (Voice Feedback) =====
Â  Â  function initTTS() {
Â  Â  Â  if (ttsInitialized || !('speechSynthesis' in window)) return;
Â  Â  Â  const utterance = new SpeechSynthesisUtterance('');
Â  Â  Â  utterance.volume = 0;
Â  Â  Â  speechSynthesis.speak(utterance);
Â  Â  Â  ttsInitialized = true;
Â  Â  }
Â  Â  document.body.addEventListener('click', initTTS, { once: true });
Â  Â  document.body.addEventListener('touchstart', initTTS, { once: true });
    function speak(text) {
        if (!ttsInitialized) return;
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-GB';
        utterance.rate = 1;
        speechSynthesis.cancel();
        speechSynthesis.speak(utterance);
    }
    
Â  Â  // ===== MAP & GPS FUNCTIONS =====
Â  Â  const BLACK_CAB_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 58 36" width="58" height="36">
Â  Â  Â  <rect x="4" y="14" width="50" height="14" rx="3" ry="3" fill="#000"/>
Â  Â  Â  <path d="M18 14v-4c0-3 2-5 5-5h12c3 0 5 2 5 5v4h-22z" fill="#000"/>
Â  Â  Â  <rect x="25" y="4" width="8" height="3" rx="1" fill="#FFD700" stroke="#000" stroke-width="0.5"/>
Â  Â  Â  <text x="29" y="6.6" text-anchor="middle" font-size="2.2" font-weight="bold" fill="#000" font-family="Arial, sans-serif">TAXI</text>
Â  Â  Â  <rect x="21" y="7" width="6" height="6" rx="1" fill="#fff"/>
Â  Â  Â  <rect x="31" y="7" width="6" height="6" rx="1" fill="#fff"/>
Â  Â  Â  <circle cx="15" cy="28" r="4" fill="#fff" stroke="#000" stroke-width="1"/>
Â  Â  Â  <circle cx="43" cy="28" r="4" fill="#fff" stroke="#000" stroke-width="1"/>
Â  Â  </svg>`;
Â  Â  function createBlackCabIcon(heading = 0) {
Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  div.innerHTML = BLACK_CAB_SVG;
Â  Â  Â  const svg = div.firstElementChild;
Â  Â  Â  svg.style.transform = `rotate(${heading}deg)`;
Â  Â  Â  svg.style.transformOrigin = 'center';
Â  Â  Â  return L.divIcon({
Â  Â  Â  Â  html: svg.outerHTML,
Â  Â  Â  Â  iconSize: [58, 36],
Â  Â  Â  Â  iconAnchor: [29, 18],
Â  Â  Â  Â  className: 'taxi-marker'
Â  Â  Â  });
Â  Â  }

    function createOtherDriverIcon(driverId, status) {
        const color = status === 'available' ? '#28a745' : '#ffc107';
        return L.divIcon({
            html: `<div class="other-driver-icon" style="background:${color};">${driverId.slice(0, 3)}</div>`,
            iconSize: [32, 32],
            iconAnchor: [16, 16],
            className: 'taxi-marker'
        });
    }

Â  Â  function calculateDistance(lat1, lon1, lat2, lon2) {
Â  Â  Â  const R = 6371000;
Â  Â  Â  const Ï†1 = (lat1 * Math.PI) / 180;
Â  Â  Â  const Ï†2 = (lat2 * Math.PI) / 180;
Â  Â  Â  const Î”Ï† = ((lat2 - lat1) * Math.PI) / 180;
Â  Â  Â  const Î”Î» = ((lon2 - lon1) * Math.PI) / 180;
Â  Â  Â  const a = Math.sin(Î”Ï†/2)**2 + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2)**2;
Â  Â  Â  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
Â  Â  }

Â  Â  function updateDriverMarker(lat, lng, headingValue) {
Â  Â  Â  if (!driverMarker) return;
Â  Â  Â  driverMarker.setLatLng([lat, lng]);
Â  Â  Â  driverMarker.setIcon(createBlackCabIcon(headingValue));
Â  Â  }

Â  Â  function updateMapCenter(lat, lng) {
Â  Â  Â  if (!map) return;
Â  Â  Â  const center = map.getCenter();
Â  Â  Â  const dist = calculateDistance(center.lat, center.lng, lat, lng);
Â  Â  Â  if (dist > 50) map.panTo([lat, lng]);
Â  Â  }
    
    function initMap() {
        loadingOverlay.style.display = 'flex';
        map = L.map('map', { zoomControl: false }).setView([51.505, -0.09], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        driverMarker = L.marker([0, 0], { icon: createBlackCabIcon(0) }).addTo(map);

        L.control.zoom({ position: 'bottomright' }).addTo(map);
        
        initGPS();
        loadingOverlay.style.display = 'none';
    }

    function updateGPSStatus(accuracy) {
        let sourceClass = 'gps-poor';
        let message = 'Poor GPS signal';
        if (accuracy < 20) {
            sourceClass = 'gps-gps';
            message = `GPS active (${accuracy.toFixed(1)}m)`;
        } else if (accuracy < 100) {
            sourceClass = 'gps-network';
            message = `Network signal (${accuracy.toFixed(1)}m)`;
        }
        statusEl.innerHTML = `<span class="gps-source ${sourceClass}"></span>${message} | Status: ${driverPresence.toUpperCase()}`;
    }
    
    function initGPS() {
        if (!navigator.geolocation) {
            statusEl.textContent = 'Geolocation not supported.';
            return;
        }
        if (gpsWatchId) navigator.geolocation.clearWatch(gpsWatchId);

        gpsWatchId = navigator.geolocation.watchPosition(
            (pos) => {
                const { latitude, longitude, accuracy, heading } = pos.coords;
                driverCoords = { lat: latitude, lng: longitude, heading, accuracy };
                
                updateDriverMarker(latitude, longitude, heading);
                updateMapCenter(latitude, longitude);
                updateGPSStatus(accuracy);

                if (driverPresence !== 'offline' && client?.connected) {
                    publishLocationThrottled(driverCoords);
                }
            },
            (err) => {
                console.warn(`GPS ERROR(${err.code}): ${err.message}`);
                updateGPSStatus(9999);
            },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
        );
    }
    
    function updateOtherDriverLocation(payload) {
        if (payload.status === 'offline') {
            if (otherDriverMarkers[payload.driver]) {
                map.removeLayer(otherDriverMarkers[payload.driver]);
                delete otherDriverMarkers[payload.driver];
            }
            return;
        }

        const latlng = [payload.lat, payload.lng];
        if (!otherDriverMarkers[payload.driver]) {
            otherDriverMarkers[payload.driver] = L.marker(latlng, { 
                icon: createOtherDriverIcon(payload.driver, payload.status) 
            }).addTo(map).bindPopup(payload.driver);
        } else {
            otherDriverMarkers[payload.driver].setLatLng(latlng);
            otherDriverMarkers[payload.driver].setIcon(createOtherDriverIcon(payload.driver, payload.status));
        }
    }

    function updateOtherDriverStatus(payload) {
        if (otherDriverMarkers[payload.driver]) {
             otherDriverMarkers[payload.driver].setIcon(createOtherDriverIcon(payload.driver, payload.status));
        }
    }

Â  Â  // ===== PASSENGER PRESET HANDLING =====
Â  Â  function handlePassengerPreset(data) {
Â  Â  Â  console.log("ğŸ’¬ Passenger preset received:", data);
Â  Â  Â  const preset = data?.presetType || "Unknown";
Â  Â  Â  const passengerMsg =
Â  Â  Â  Â  preset === "where_are_you" ? "Passenger asks: Where are you?" :
Â  Â  Â  Â  preset === "cancel_ride" ? "Passenger wants to cancel the ride." :
Â  Â  Â  Â  preset === "call_driver" ? "Passenger is trying to call you." :
Â  Â  Â  Â  `Passenger message: ${preset}`;

Â  Â  Â  speak(passengerMsg);
Â  Â  Â  showPassengerPopup(passengerMsg, data);
Â  Â  }

Â  Â  function showPassengerPopup(msg, data) {
Â  Â  Â  const popup = document.getElementById('passengerPopup');
Â  Â  Â  const msgEl = document.getElementById('passengerPopupMsg');
Â  Â  Â  msgEl.textContent = msg;
Â  Â  Â  popup.style.display = 'block';

Â  Â  Â  setTimeout(() => { popup.style.display = 'none'; }, 15000);

Â  Â  Â  document.getElementById('presetReply1').onclick = () => sendPresetReply('on_my_way', data);
Â  Â  Â  document.getElementById('presetReply2').onclick = () => sendPresetReply('arrived', data);
Â  Â  }

Â  Â  function sendPresetReply(type, data) {
Â  Â  Â  const payload = {
Â  Â  Â  Â  type: 'driver_preset_reply',
Â  Â  Â  Â  replyType: type,
Â  Â  Â  Â  driverId: DRIVER_ID,
Â  Â  Â  Â  jobId: data?.jobId || null,
Â  Â  Â  Â  timestamp: new Date().toISOString()
Â  Â  Â  };
Â  Â  Â  client.publish('server/preset_replies', JSON.stringify(payload));
Â  Â  Â  document.getElementById('passengerPopup').style.display = 'none';
Â  Â  Â  console.log("ğŸ“¤ Sent preset reply:", type);
Â  Â  }

Â  Â  // ===== LOCATION PUBLISH =====
Â  Â  let lastPublish = 0;
Â  Â  let lastPublishCoords = null;

Â  Â  function publishLocationThrottled(gpsData) {
Â  Â  Â  const now = Date.now();
Â  Â  Â  if (!lastPublishCoords ||
Â  Â  Â  Â  Â  calculateDistance(lastPublishCoords.lat, lastPublishCoords.lng, gpsData.lat, gpsData.lng) > 5 ||
Â  Â  Â  Â  Â  now - lastPublish > 3000) {
Â  Â  Â  Â  client.publish(`drivers/${DRIVER_ID}/location`, JSON.stringify({
Â  Â  Â  Â  Â  driver: DRIVER_ID,
Â  Â  Â  Â  Â  lat: gpsData.lat,
Â  Â  Â  Â  Â  lng: gpsData.lng,
Â  Â  Â  Â  Â  status: driverPresence, 
Â  Â  Â  Â  Â  ts: now,
Â  Â  Â  Â  Â  heading: Math.round(gpsData.heading || 0)
Â  Â  Â  Â  }));
Â  Â  Â  Â  lastPublish = now;
Â  Â  Â  Â  lastPublishCoords = { lat: gpsData.lat, lng: gpsData.lng };
Â  Â  Â  }
Â  Â  }

Â  Â  // ===== STATUS HANDLING =====
Â  Â  function setDriverPresence(status) {
Â  Â  Â  if (!['available', 'busy', 'offline'].includes(status)) return;
      if (status === driverPresence) return;
Â  Â  Â  driverPresence = status;
Â  Â  Â  localStorage.setItem('driver_presence', status);

Â  Â  Â  const caption = document.getElementById('statusCaption');
Â  Â  Â  caption.className = `status-${status}`;
Â  Â  Â  caption.innerHTML = `<span class="status-dot"></span> ${status.charAt(0).toUpperCase() + status.slice(1)}`;

Â  Â  Â  if (status === 'offline' && gpsWatchId) {
Â  Â  Â  Â  navigator.geolocation.clearWatch(gpsWatchId);
Â  Â  Â  Â  gpsWatchId = null;
Â  Â  Â  } else if (status !== 'offline' && !gpsWatchId) {
Â  Â  Â  Â  initGPS();
Â  Â  Â  } else if (status !== 'offline' && driverCoords) {
Â  Â  Â  Â  publishLocationThrottled(driverCoords);
Â  Â  Â  }

Â  Â  Â  // PUBLISH STATUS TO MQTT
Â  Â  Â  if (client && client.connected) {
Â  Â  Â  Â  client.publish(`drivers/${DRIVER_ID}/status`, JSON.stringify({
Â  Â  Â  Â  Â  driver: DRIVER_ID,
Â  Â  Â  Â  Â  status: status,
Â  Â  Â  Â  Â  ts: Date.now()
Â  Â  Â  Â  }));
Â  Â  Â  }
Â  Â  }
    
    function handleLogOff() {
        setDriverPresence('offline');
        if (client) client.end();
        // Here you would redirect to a login page
        alert('You have been logged off.');
    }

Â  Â  // ===== FCM (Service Worker Registration) =====
Â  Â  async function requestFCMToken() {
Â  Â  Â  try {
Â  Â  Â  Â  const permission = await Notification.requestPermission();
Â  Â  Â  Â  if (permission !== 'granted') return null;
Â  Â  Â  Â  
        // CRITICAL: Registering the SW with the scope matching the path
Â  Â  Â  Â  const registration = await navigator.serviceWorker.register(
Â  Â  Â  Â  Â  '/blackcabunite/firebase-messaging-sw.js',
Â  Â  Â  Â  Â  { scope: '/blackcabunite/' }
Â  Â  Â  Â  );
Â  Â  Â  Â  fcmToken = await messaging.getToken({
Â  Â  Â  Â  Â  vapidKey: VAPID_KEY,
Â  Â  Â  Â  Â  serviceWorkerRegistration: registration
Â  Â  Â  Â  });
Â  Â  Â  Â  if (fcmToken) {
Â  Â  Â  Â  Â  console.log('âœ… FCM ready');
Â  Â  Â  Â  Â  publishFcmToken();
Â  Â  Â  Â  }
Â  Â  Â  Â  return fcmToken;
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error('FCM error:', err);
        if (err.message.includes('messaging/failed-serviceworker-registration')) {
            console.error("HINT: Service worker failed. Check that 'firebase-messaging-sw.js' is in your site's /blackcabunite/ directory and accessible.");
        }
Â  Â  Â  Â  return null;
Â  Â  Â  }
Â  Â  }

Â  Â  // PUBLISH TO drivers/tokens WITH driverId
Â  Â  function publishFcmToken() {
Â  Â  Â  if (!client?.connected || !fcmToken || !DRIVER_ID) return;
Â  Â  Â  client.publish('drivers/tokens', JSON.stringify({
Â  Â  Â  Â  driverId: DRIVER_ID,
Â  Â  Â  Â  fcmToken: fcmToken,
Â  Â  Â  Â  ts: Date.now()
Â  Â  Â  }));
Â  Â  Â  console.log("âœ… Published FCM token to 'drivers/tokens'");
Â  Â  }

Â  Â  // ===== JOB HANDLERS =====
Â  Â  function respondToJob(accepted) {
Â  Â  Â  if (!currentJob || !client) return;
Â  Â  Â  const status = accepted ? "bidding" : "rejected";
Â  Â  Â  client.publish(`jobs/${currentJob.job}/status`, JSON.stringify({
Â  Â  Â  Â  job: currentJob.job,
Â  Â  Â  Â  driver: DRIVER_ID,
Â  Â  Â  Â  status: status,
Â  Â  Â  Â  lat: driverCoords?.lat || currentJob.lat,
Â  Â  Â  Â  lng: driverCoords?.lng || currentJob.lng,
Â  Â  Â  Â  ts: Date.now()
Â  Â  Â  }));
Â  Â  Â  if (jobTimerInterval) clearInterval(jobTimerInterval);
Â  Â  Â  jobPanel.style.display = 'none';
Â  Â  Â  isJobActive = false;
Â  Â  Â  if (accepted) {
Â  Â  Â  Â  pendingJobs.push({ ...currentJob, status: 'bidding', ts: Date.now() });
Â  Â  Â  Â  localStorage.setItem(`pending_jobs_${DRIVER_ID}`, JSON.stringify(pendingJobs));
Â  Â  Â  Â  speak("Bid sent for new job.");
Â  Â  Â  }
Â  Â  Â  currentJob = null;
Â  Â  }

Â  Â  function showJobPanel(job) {
Â  Â  Â  if (seenJobIds.has(job.job)) return;
Â  Â  Â  seenJobIds.add(job.job);
Â  Â  Â  isJobActive = true;
Â  Â  Â  currentJob = job;
Â  Â  Â  jobPanel.style.display = 'block';
Â  Â  Â  pickupLocation.textContent = `${job.pubName} (${job.lat.toFixed(5)}, ${job.lng.toFixed(5)})`;
Â  Â  Â  customerName.textContent = job.customerName || 'Not provided';
Â  Â  Â  customerPhone.textContent = job.customerPhone || 'Not provided';
      speak(`New job request near ${job.pubName}`);
      
Â  Â  Â  document.getElementById('jobTimer').style.display = 'block';
Â  Â  Â  let seconds = 30;
Â  Â  Â  document.getElementById('timerSeconds').textContent = seconds;
Â  Â  Â  if (jobTimerInterval) clearInterval(jobTimerInterval);
Â  Â  Â  jobTimerInterval = setInterval(() => {
Â  Â  Â  Â  seconds--;
Â  Â  Â  Â  document.getElementById('timerSeconds').textContent = seconds;
Â  Â  Â  Â  if (seconds <= 0) {
Â  Â  Â  Â  Â  clearInterval(jobTimerInterval);
Â  Â  Â  Â  Â  jobPanel.style.display = 'none';
Â  Â  Â  Â  Â  isJobActive = false;
Â  Â  Â  Â  Â  currentJob = null;
Â  Â  Â  Â  }
Â  Â  Â  }, 1000);
Â  Â  }
    
    function showJobWonModal(job) {
        document.getElementById('jobWonModal').style.display = 'flex';
        speak("Congratulations! You have been allocated a new job.");
    }
    
    function handleJobUpdate(payload) {
      if (payload.driver !== DRIVER_ID) return; 

      // Remove from pending jobs if status changes
      pendingJobs = pendingJobs.filter(j => j.job !== payload.job);
      localStorage.setItem(`pending_jobs_${DRIVER_ID}`, JSON.stringify(pendingJobs));


      if (payload.status === 'allocated') {
        const existingJob = driverJobs.find(j => j.job === payload.job);
        if (!existingJob) {
          driverJobs.push({ ...payload, ts: Date.now() });
          localStorage.setItem(`driver_jobs_${DRIVER_ID}`, JSON.stringify(driverJobs));
          showJobWonModal(payload);
          setDriverPresence('busy');
        }
        currentJob = driverJobs.find(j => j.job === payload.job);
        if (isMenuOpen && currentView === 'currentJob') renderCurrentJobView(); 

      } else if (['lost', 'completed', 'cancelled', 'rejected', 'expired'].includes(payload.status)) {
         driverJobs = driverJobs.filter(j => j.job !== payload.job); // Remove old entry if exists
         driverJobs.push({ ...payload, ts: Date.now() });
         localStorage.setItem(`driver_jobs_${DRIVER_ID}`, JSON.stringify(driverJobs));
         if (payload.job === currentJob?.job) {
             currentJob = null;
             // Only revert to available if job completed/cancelled and driver was busy
             if (driverPresence === 'busy') setDriverPresence('available');
         }
         if (isMenuOpen) {
            if (currentView === 'jobHistory') renderJobHistory();
            if (currentView === 'currentJob') renderCurrentJobView();
         }
      } 
    }
    
    function endCurrentJob(status) {
        if (!currentJob) return;

        const payload = {
            job: currentJob.job,
            driver: DRIVER_ID,
            status: status, // 'completed' or 'cancelled'
            ts: Date.now()
        };
        client.publish(`jobs/${currentJob.job}/status`, JSON.stringify(payload));
        
        // Update local state and remove from active job list
        handleJobUpdate(payload); 
        
        // Ensure menu updates
        if (isMenuOpen) renderCurrentJobView();
    }


Â  Â  // ===== MQTT =====
Â  Â  function connectMQTT() {
Â  Â  Â  statusEl.innerHTML = `<span class="gps-source gps-poor"></span>Connecting to MQTT as: ${DRIVER_ID}`;
Â  Â  Â  client = mqtt.connect(MQTT_BROKER, {
Â  Â  Â  Â  clientId: 'driver-' + DRIVER_ID + '-' + Math.random().toString(16).substr(2,8),
Â  Â  Â  Â  clean: true,
Â  Â  Â  Â  reconnectPeriod: 1000
Â  Â  Â  });
Â  Â  Â  client.on('connect', () => {
Â  Â  Â  Â  statusEl.innerHTML = `<span class="gps-source gps-gps"></span>Connected as: ${DRIVER_ID}`;
        // SUBSCRIBE TO ALL JOB REQUESTS and filter locally by distance
Â  Â  Â  Â  client.subscribe("pubs/requests/+"); 
Â  Â  Â  Â  client.subscribe(`jobs/${DRIVER_ID}/status`); // Subscribe to job updates specifically for this driver
Â  Â  Â  Â  client.subscribe("drivers/+/location");
Â  Â  Â  Â  client.subscribe("drivers/+/status");
Â  Â  Â  Â  client.subscribe("chat/group");
        client.subscribe(`chat/${DRIVER_ID}`); // Direct chat
        client.subscribe(`passenger/${DRIVER_ID}/preset`); // Passenger presets
        
        // Publish initial presence and FCM token
        setDriverPresence(driverPresence);
        publishFcmToken();

Â  Â  Â  Â  client.on('message', (topic, message) => {
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const payload = JSON.parse(message.toString());
Â  Â  Â  Â  Â  Â  console.log(`ğŸ“¥ MQTT Message on ${topic}:`, payload);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (topic.startsWith('pubs/requests/')) {
                // Job Request - filter by distance
Â  Â  Â  Â  Â  Â  Â  Â  const distance = driverCoords ? calculateDistance(driverCoords.lat, driverCoords.lng, payload.lat, payload.lng) / 1000 : Infinity;
Â  Â  Â  Â  Â  Â  Â  Â  if (distance <= maxRadius && !isJobActive && !seenJobIds.has(payload.job)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  showJobPanel(payload);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else if (topic.startsWith(`jobs/${DRIVER_ID}/status`)) {
                // Job Status Update
Â  Â  Â  Â  Â  Â  Â  Â  handleJobUpdate(payload);
Â  Â  Â  Â  Â  Â  } else if (topic === 'chat/group' || topic === `chat/${DRIVER_ID}`) {
                // Chat Message
Â  Â  Â  Â  Â  Â  Â  Â  handleGroupChat(payload);
Â  Â  Â  Â  Â  Â  } else if (topic.startsWith('drivers/') && topic.endsWith('/location') && payload.driver !== DRIVER_ID) {
                // Other Driver Location Update
Â  Â  Â  Â  Â  Â  Â  Â  updateOtherDriverLocation(payload);
Â  Â  Â  Â  Â  Â  } else if (topic.startsWith('drivers/') && topic.endsWith('/status') && payload.driver !== DRIVER_ID) {
                // Other Driver Status Update
Â  Â  Â  Â  Â  Â  Â  Â  updateOtherDriverStatus(payload);
Â  Â  Â  Â  Â  Â  } else if (topic.startsWith('passenger/') && topic.endsWith('/preset')) {
                // Passenger Preset Message
Â  Â  Â  Â  Â  Â  Â  Â  handlePassengerPreset(payload);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.error('MQTT message error:', e);
Â  Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â  client.on('error', (err) => {
Â  Â  Â  Â  console.error('MQTT Error:', err);
Â  Â  Â  Â  statusEl.innerHTML = `<span class="gps-source gps-poor"></span>MQTT Error. Reconnecting...`;
Â  Â  Â  });
Â  Â  }
    
    // ===== MENU AND VIEW LOGIC =====
    function toggleMenu() {
        isMenuOpen = !isMenuOpen;
        menuPanel.classList.toggle('active', isMenuOpen);
        if (isMenuOpen) {
            renderCurrentView();
        }
    }

    function renderCurrentJobView() {
      let html = '';
      if (currentJob) {
        html = `
          <div class="current-job-info">
            <h3 style="color:#28a745;">Active Job: ${currentJob.job}</h3>
            <div class="job-detail">
              <div class="job-label">Pickup Location</div>
              <div class="job-value">${currentJob.pubName}</div>
            </div>
            <div class="job-detail">
              <div class="job-label">Customer Name</div>
              <div class="job-value">${currentJob.customerName || 'N/A'}</div>
            </div>
            <div class="job-detail">
              <div class="job-label">Customer Phone</div>
              <div class="job-value">${currentJob.customerPhone || 'N/A'}</div>
            </div>
            <div class="job-detail">
              <div class="job-label">Status</div>
              <div class="job-value"><span class="job-status status-allocated">ALLOCATED (En Route)</span></div>
            </div>
          </div>
          <button class="settings-btn" style="background:#28a745;" onclick="endCurrentJob('completed')">COMPLETE JOB</button>
          <button class="settings-btn" style="background:#dc3545; margin-top:10px;" onclick="endCurrentJob('cancelled')">CANCEL/NO SHOW</button>
        `;
      } else {
        html = `
          <div class="no-current-job">
            <div class="icon">ğŸ˜´</div>
            <p>No job is currently allocated to you.</p>
            <p>Set your status to **Available** and wait for a request.</p>
          </div>
        `;
      }
      menuContent.innerHTML = html;
    }

    function renderJobHistory() {
      let history = [...driverJobs].sort((a, b) => b.ts - a.ts);
      let html = history.map(job => {
        const statusClass = `status-${job.status}`;
        const itemClass = `job-item ${job.status}`;
        const statusText = job.status.charAt(0).toUpperCase() + job.status.slice(1);
        const date = new Date(job.ts).toLocaleString();
        return `
          <div class="${itemClass}">
            <div class="job-id">#${job.job}</div>
            <div class="job-pub">ğŸ“ Pickup: ${job.pubName}</div>
            <div class="job-pub">ğŸ‘¤ Customer: ${job.customerName || 'N/A'}</div>
            <div class="job-phone">ğŸ“ Phone: ${job.customerPhone || 'N/A'}</div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
              <span class="job-status ${statusClass}">${statusText}</span>
              <span style="font-size:12px; color:#999;">${date}</span>
            </div>
          </div>
        `;
      }).join('');
      
      if (history.length === 0) {
        html = '<p class="no-current-job">No job history available.</p>';
      }
      
      menuContent.innerHTML = `<h3>Job History (${history.length})</h3>` + html;
    }

    function renderChatView() {
      const messages = chatMessages[currentChat] || [];
      const isGroup = currentChat === 'group';
      
      const chatHtml = messages.map(msg => {
          const type = msg.driverId === DRIVER_ID ? 'sent' : 'received';
          const time = new Date(msg.ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          const sender = msg.driverId || 'Passenger';
          return `
            <div class="message ${type}">
              ${isGroup && type === 'received' ? `<div style="font-weight: bold; font-size: 11px; color: #1f6feb; margin-bottom: 4px;">${sender}</div>` : ''}
              ${msg.message}
              <div class="message-info">${time}</div>
            </div>
          `;
      }).join('');

      menuContent.innerHTML = `
        <div id="chatContainer" style="height: calc(70vh - 120px); display: flex; flex-direction: column;">
          <div id="chatMessages" style="flex: 1; overflow-y: auto;">${chatHtml}</div>
          <div id="chatInputContainer">
            <input type="text" id="chatInput" placeholder="Type a message..." />
            <button id="sendBtn" onclick="sendMessage()">â¤</button>
          </div>
        </div>
      `;
      // Scroll to bottom
      const chatMsgsEl = document.getElementById('chatMessages');
      if (chatMsgsEl) chatMsgsEl.scrollTop = chatMsgsEl.scrollHeight;
    }
    
    function sendMessage() {
        const input = document.getElementById('chatInput');
        const messageText = input.value.trim();
        if (!messageText) return;
        
        const payload = {
            driverId: DRIVER_ID,
            message: messageText,
            ts: Date.now()
        };
        
        client.publish(`chat/${currentChat}`, JSON.stringify(payload));
        
        // Add locally
        if (!chatMessages[currentChat]) chatMessages[currentChat] = [];
        chatMessages[currentChat].push(payload);
        localStorage.setItem(`chat_${currentChat}_${DRIVER_ID}`, JSON.stringify(chatMessages[currentChat]));
        
        input.value = '';
        renderChatView();
    }
    
    function handleGroupChat(msg) {
        if (!chatMessages.group) chatMessages.group = [];
        chatMessages.group.push(msg);
        localStorage.setItem(`chat_group_${DRIVER_ID}`, JSON.stringify(chatMessages.group));
        
        if (isMenuOpen && currentView === 'chat' && currentChat === 'group') {
            renderChatView();
        } else if (!isMenuOpen) {
            unreadCounts.group++;
            // Show a simple notification
            statusEl.textContent = `New message from Group Chat (${unreadCounts.group})`;
        }
    }
    
    function renderSettingsView() {
        menuContent.innerHTML = `
            <div class="settings-group">
                <div class="settings-label">Driver Identification</div>
                <div class="settings-info">
                    Your ID is used for job allocation and tracking.
                </div>
                <input type="text" class="settings-input" id="driverIdInput" value="${DRIVER_ID}" readonly style="background:#eee;"/>
                <button class="settings-btn" onclick="alert('Driver ID cannot be changed once set. Please contact support.')">Update ID</button>
            </div>
            
            <div class="settings-group">
                <div class="settings-label">Job Search Radius (km)</div>
                <div class="settings-info">
                    You will only receive job requests within this distance of your current location.
                </div>
                <input type="number" class="settings-input" id="maxRadiusInput" value="${maxRadius}" min="1" max="50"/>
                <button class="settings-btn" onclick="updateRadius()">Save Radius</button>
            </div>
            
            <div class="settings-group">
                <div class="settings-label">App Information</div>
                <div class="settings-info">
                    Version: v7.0<br>
                    MQTT Broker: ${MQTT_BROKER}<br>
                    FCM Token: ${fcmToken ? 'Ready' : 'Not ready'}
                </div>
            </div>
            
            <button class="settings-btn" style="background:#dc3545;" onclick="handleLogOff()">Log Off</button>
        `;
    }

    function updateRadius() {
        const input = document.getElementById('maxRadiusInput');
        const newRadius = parseFloat(input.value);
        if (newRadius > 0 && newRadius <= 50) {
            maxRadius = newRadius;
            localStorage.setItem('max_radius_km', newRadius);
            alert(`Job search radius set to ${newRadius} km.`);
        } else {
            alert('Please enter a value between 1 and 50.');
        }
    }

    function renderCurrentView() {
      menuNavBtns.forEach(btn => btn.classList.remove('active'));
      const activeBtn = document.querySelector(`.menu-nav-btn[data-view="${currentView}"]`);
      if (activeBtn) activeBtn.classList.add('active');

      switch (currentView) {
        case 'currentJob':
          renderCurrentJobView();
          break;
        case 'jobHistory':
          renderJobHistory();
          break;
        case 'chat':
          renderChatView();
          break;
        case 'settings':
          renderSettingsView();
          break;
      }
    }

Â  Â  // ===== INIT =====
Â  Â  document.addEventListener('DOMContentLoaded', () => {
      // 1. Initial Map Setup and Location Tracking
      initMap(); 
      
      // 2. Initial MQTT Connection
      connectMQTT();

      // 3. Status Init
      setDriverPresence(driverPresence); 

      // 4. Menu Panel Logic
      document.getElementById('menuBtn').addEventListener('click', toggleMenu);
      menuNavBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          currentView = btn.dataset.view;
          renderCurrentView();
        });
      });
      renderCurrentView(); 
      
      // 5. Job action buttons
      document.getElementById('acceptBtn').addEventListener('click', () => respondToJob(true));
      document.getElementById('rejectBtn').addEventListener('click', () => respondToJob(false));
      document.getElementById('closeJobWonModal').addEventListener('click', () => {
          document.getElementById('jobWonModal').style.display = 'none';
      });

      // 6. Status Dropdown Toggle
      const appTitleContainer = document.getElementById('appTitleContainer');
      const statusDropdown = document.getElementById('statusDropdown');
      appTitleContainer.addEventListener('click', (e) => {
        e.stopPropagation();
        statusDropdown.style.display = statusDropdown.style.display === 'flex' ? 'none' : 'flex';
      });
      document.querySelectorAll('.status-option').forEach(option => {
        option.addEventListener('click', () => {
          setDriverPresence(option.dataset.status);
          statusDropdown.style.display = 'none';
        });
      });
      document.getElementById('logOffBtn').addEventListener('click', handleLogOff);
      document.addEventListener('click', () => {
        statusDropdown.style.display = 'none';
      });
      statusDropdown.addEventListener('click', (e) => {
        e.stopPropagation();
      });

      // 7. Initial FCM request
      if ('serviceWorker' in navigator && Notification.permission !== 'denied') {
        requestFCMToken();
      }

    });
Â  </script>
</body>
</html>
