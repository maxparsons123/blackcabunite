<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Black Cab Unite - Driver Dispatch</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#000000">
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-messaging-compat.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: #f7fafc;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    
    /* Header */
    #header {
      background: #000;
      color: #FFD700;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1001;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    #appTitle {
      font-weight: 700;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    #statusText {
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    .status-available .status-dot { background: #28a745; }
    .status-busy .status-dot { background: #ffc107; }
    .status-offline .status-dot { background: #dc3545; }
    
    #menuBtn {
      background: #FFD700;
      color: #000;
      border: none;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    
    /* Status Dropdown */
    #statusDropdown {
      position: absolute;
      top: 60px;
      left: 16px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 9999;
      display: none;
      min-width: 180px;
    }
    .status-option {
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid #eee;
    }
    .status-option:last-child { border-bottom: none; }
    .status-option:hover { background: #f8f9fa; }
    
    /* Map */
    #map {
      flex: 1;
      width: 100%;
      z-index: 1;
    }
    .taxi-marker {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
    }
    
    /* Status Bar */
    #statusBar {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 8px 16px;
      border-radius: 24px;
      font-size: 14px;
      font-weight: 600;
      z-index: 400;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* Job Panel */
    #jobPanel {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 20px;
      border-top: 2px solid #eee;
      z-index: 500;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
      display: none;
    }
    #jobPanel h2 {
      text-align: center;
      margin-bottom: 16px;
      font-size: 20px;
      color: #000;
    }
    .job-info {
      background: #f8f9fa;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 16px;
    }
    .job-label {
      font-weight: 600;
      color: #666;
      font-size: 14px;
      margin-bottom: 4px;
    }
    .job-value {
      font-size: 16px;
      color: #000;
      margin-bottom: 12px;
    }
    .job-timer {
      color: #dc3545;
      font-weight: bold;
      margin-top: 12px;
    }
    .job-actions {
      display: flex;
      gap: 12px;
    }
    .job-btn {
      flex: 1;
      padding: 16px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
    }
    .accept-btn {
      background: #28a745;
      color: white;
    }
    .reject-btn {
      background: #dc3545;
      color: white;
    }
    
    /* Menu Panel */
    #menuPanel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 80vh;
      background: white;
      z-index: 9999;
      transform: translateY(100%);
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
    }
    #menuPanel.active {
      transform: translateY(0);
    }
    
    /* Menu Tabs */
    .menu-tabs {
      display: flex;
      background: #f8f9fa;
      border-bottom: 1px solid #eee;
    }
    .menu-tab {
      flex: 1;
      padding: 16px;
      background: transparent;
      border: none;
      font-weight: 600;
      cursor: pointer;
      color: #666;
    }
    .menu-tab.active {
      background: white;
      color: #000;
      border-bottom: 3px solid #FFD700;
    }
    
    /* Chat View */
    #chatView {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    #chatHeader {
      background: #000;
      color: #FFD700;
      padding: 12px 16px;
      font-weight: bold;
    }
    #chatMessages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .message {
      max-width: 85%;
      padding: 12px 16px;
      border-radius: 16px;
      word-wrap: break-word;
    }
    .message.sent {
      align-self: flex-end;
      background: #000;
      color: #FFD700;
      border-bottom-right-radius: 4px;
    }
    .message.received {
      align-self: flex-start;
      background: #f1f3f5;
      color: #000;
      border-bottom-left-radius: 4px;
    }
    .message-sender {
      font-size: 11px;
      font-weight: bold;
      margin-bottom: 4px;
      opacity: 0.8;
    }
    .message-time {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 4px;
    }
    #chatInput {
      display: flex;
      padding: 12px;
      background: white;
      border-top: 1px solid #eee;
      gap: 8px;
    }
    #chatInput input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #ddd;
      border-radius: 24px;
      font-size: 16px;
      outline: none;
    }
    #chatInput input:focus {
      border-color: #FFD700;
    }
    #sendBtn {
      background: #000;
      color: #FFD700;
      border: none;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      cursor: pointer;
      font-weight: bold;
    }
    
    /* Job History */
    .job-item {
      padding: 16px;
      border: 1px solid #eee;
      border-radius: 12px;
      margin-bottom: 12px;
      background: #f9f9f9;
    }
    .job-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .job-id {
      font-weight: bold;
    }
    .job-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }
    .badge-completed { background: #28a745; color: white; }
    .badge-rejected { background: #dc3545; color: white; }
    .badge-allocated { background: #1f6feb; color: white; }
    .badge-bidding { background: #ffc107; color: #333; }
    
    /* Settings */
    .settings-content {
      padding: 20px;
    }
    .settings-group {
      margin-bottom: 20px;
    }
    .settings-label {
      font-weight: bold;
      margin-bottom: 8px;
      display: block;
    }
    .settings-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    .settings-btn {
      width: 100%;
      padding: 14px;
      background: #000;
      color: #FFD700;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 12px;
    }
    .settings-info {
      background: #f8f9fa;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    
    .menu-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: none;
    }
    .menu-content.active {
      display: block;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }
    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    /* Passenger Preset Popup */
    #passengerPopup {
      display: none;
      position: fixed;
      bottom: 120px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 18px 20px;
      border-radius: 16px;
      font-size: 16px;
      max-width: 300px;
      text-align: center;
      z-index: 3000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    .replyBtn {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      flex: 1;
      margin: 0 4px;
    }
    .replyBtn:nth-child(2) {
      background: #1f6feb;
    }
  </style>
</head>
<body>
  <div id="header">
    <div id="appTitle">
      <div>üöï Black Cab Unite</div>
      <div id="statusText" class="status-available">
        <span class="status-dot"></span>
        Available
      </div>
    </div>
    <button id="menuBtn">‚ò∞</button>
  </div>
  
  <div id="statusDropdown">
    <div class="status-option" data-status="available">
      <span class="status-dot" style="background:#28a745;"></span>
      Available
    </div>
    <div class="status-option" data-status="busy">
      <span class="status-dot" style="background:#ffc107;"></span>
      Busy
    </div>
    <div class="status-option" data-status="offline">
      <span class="status-dot" style="background:#dc3545;"></span>
      Offline
    </div>
  </div>
  
  <div id="map"></div>
  
  <div id="statusBar">
    <span class="status-dot" style="background:#28a745;"></span>
    <span id="statusBarText">Initializing...</span>
  </div>
  
  <div id="jobPanel">
    <h2>üöï New Job Request</h2>
    <div class="job-info">
      <div class="job-label">Pickup Location</div>
      <div class="job-value" id="jobPickup">Loading...</div>
      <div class="job-label">Customer Name</div>
      <div class="job-value" id="jobCustomer">Loading...</div>
      <div class="job-label">Customer Phone</div>
      <div class="job-value" id="jobPhone">Loading...</div>
      <div class="job-timer" id="jobTimer" style="display:none;">
        ‚è≥ Expires in: <span id="timerSeconds">30</span>s
      </div>
    </div>
    <div class="job-actions">
      <button class="job-btn accept-btn" id="acceptBtn">‚úÖ ACCEPT JOB</button>
      <button class="job-btn reject-btn" id="rejectBtn">‚ùå REJECT</button>
    </div>
  </div>
  
  <div id="menuPanel">
    <div class="menu-tabs">
      <button class="menu-tab active" data-tab="chat">üí¨ Chat</button>
      <button class="menu-tab" data-tab="history">üìã History</button>
      <button class="menu-tab" data-tab="settings">‚öôÔ∏è Settings</button>
    </div>
    
    <div id="chatView" class="menu-content active">
      <div id="chatHeader">Driver Group Chat</div>
      <div id="chatMessages"></div>
      <div id="chatInput">
        <input type="text" id="messageInput" placeholder="Type a message..." />
        <button id="sendBtn">‚û§</button>
      </div>
    </div>
    
    <div id="historyView" class="menu-content">
      <div id="historyList"></div>
    </div>
    
    <div id="settingsView" class="menu-content">
      <div class="settings-content">
        <div class="settings-info">
          <strong>Driver ID:</strong> <span id="driverIdDisplay"></span>
        </div>
        <div class="settings-group">
          <label class="settings-label">Driver Name</label>
          <input type="text" class="settings-input" id="driverName" placeholder="Enter your name" />
        </div>
        <div class="settings-group">
          <label class="settings-label">Phone Number</label>
          <input type="tel" class="settings-input" id="driverPhone" placeholder="Enter your phone" />
        </div>
        <button class="settings-btn" id="saveSettings">Save Settings</button>
        <button class="settings-btn" id="clearHistory" style="background:#dc3545; margin-top:20px;">
          Clear All History
        </button>
      </div>
    </div>
  </div>

  <div id="passengerPopup">
    <div id="passengerPopupMsg">Passenger message...</div>
    <div style="display:flex; justify-content:center; gap:10px; margin-top:12px;">
      <button id="presetReply1" class="replyBtn">On my way</button>
      <button id="presetReply2" class="replyBtn">Arrived</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    // ===== GLOBAL STATE =====
    let DRIVER_ID = localStorage.getItem('driver_id');
    let driverStatus = localStorage.getItem('driver_status') || 'available';
    let map = null;
    let driverMarker = null;
    let mqttClient = null;
    let currentLocation = null;
    let currentJob = null;
    let jobTimer = null;
    let speechRecognition = null;
    let isSpeaking = false;
    let voiceAttemptCount = 0;
    const MAX_VOICE_ATTEMPTS = 3;
    const TTS_TO_MIC_DELAY_MS = 600;
    let fcmToken = null;

    // ===== INIT DRIVER ID =====
    if (!DRIVER_ID) {
      DRIVER_ID = prompt('Enter your driver ID (letters, numbers, - _ only):') || 'driver-' + Math.random().toString(36).substr(2, 8);
      localStorage.setItem('driver_id', DRIVER_ID);
    }
    document.getElementById('driverIdDisplay').textContent = DRIVER_ID;

    // ===== FIREBASE INIT =====
    const firebaseConfig = {
      apiKey: "AIzaSyBq1aN-KRtRW7S243ef7lz7fnZmlBcuN1s",
      authDomain: "cabunite.firebaseapp.com",
      projectId: "cabunite",
      storageBucket: "cabunite.firebasestorage.app",
      messagingSenderId: "997924656033",
      appId: "1:997924656033:web:1552b9f26a1af0878eb1e0"
    };
    firebase.initializeApp(firebaseConfig);
    const messaging = firebase.messaging();
    messaging.onMessage((payload) => {
      if (Notification.permission === 'granted') {
        new Notification(payload.notification?.title || "Taxi Update", {
          body: payload.notification?.body || "You have a new message",
          icon: '/blackcabunite/icon-192.png'
        });
      }
    });

    // ===== TAXI ICON =====
    const BLACK_CAB_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 58 36" width="58" height="36">
      <rect x="4" y="14" width="50" height="14" rx="3" ry="3" fill="#000"/>
      <path d="M18 14v-4c0-3 2-5 5-5h12c3 0 5 2 5 5v4h-22z" fill="#000"/>
      <rect x="25" y="4" width="8" height="3" rx="1" fill="#FFD700" stroke="#000" stroke-width="0.5"/>
      <text x="29" y="6.6" text-anchor="middle" font-size="2.2" font-weight="bold" fill="#000">TAXI</text>
      <rect x="21" y="7" width="6" height="6" rx="1" fill="#fff"/>
      <rect x="31" y="7" width="6" height="6" rx="1" fill="#fff"/>
      <circle cx="15" cy="28" r="4" fill="#fff" stroke="#000" stroke-width="1"/>
      <circle cx="43" cy="28" r="4" fill="#fff" stroke="#000" stroke-width="1"/>
    </svg>`;

    function createTaxiIcon() {
      return L.divIcon({
        html: BLACK_CAB_SVG,
        iconSize: [58, 36],
        iconAnchor: [29, 18],
        className: 'taxi-marker'
      });
    }

    // ===== TTS / STT =====
    function speak(text, onEnd = null) {
      if (!('speechSynthesis' in window)) {
        if (onEnd) setTimeout(onEnd, 100);
        return;
      }
      isSpeaking = true;
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'en-GB';
      u.rate = 0.9;
      u.onend = () => {
        isSpeaking = false;
        if (onEnd) setTimeout(onEnd, TTS_TO_MIC_DELAY_MS);
      };
      speechSynthesis.speak(u);
    }

    function startVoiceListener() {
      if (isSpeaking || speechRecognition) return;
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) return;
      speechRecognition = new SpeechRecognition();
      speechRecognition.lang = 'en-US';
      speechRecognition.continuous = false;
      speechRecognition.interimResults = false;
      speechRecognition.onresult = (e) => {
        const t = e.results[0][0].transcript.toLowerCase();
        if (/\baccept\b/.test(t) && !/\breject\b/.test(t)) {
          voiceAttemptCount = 0;
          respondToJob(true);
          speak("Job accepted. Thank you.");
        } else if (/\breject\b/.test(t)) {
          voiceAttemptCount = 0;
          respondToJob(false);
          speak("Job rejected. Understood.");
        } else {
          voiceAttemptCount++;
          stopVoiceListener();
          promptForVoiceResponse();
        }
        speechRecognition = null;
      };
      speechRecognition.onerror = () => { speechRecognition = null; };
      speechRecognition.onend = () => { speechRecognition = null; };
      try { speechRecognition.start(); } catch (e) {}
    }

    function stopVoiceListener() {
      if (speechRecognition) {
        speechRecognition.abort();
        speechRecognition = null;
      }
    }

    function promptForVoiceResponse() {
      if (isSpeaking || !currentJob) return;
      if (voiceAttemptCount === 0) {
        setTimeout(startVoiceListener, TTS_TO_MIC_DELAY_MS);
      } else if (voiceAttemptCount < MAX_VOICE_ATTEMPTS) {
        speak("Did not hear you. Please say ‚Äòaccept‚Äô or ‚Äòreject‚Äô.", () => {
          startVoiceListener();
        });
      } else {
        speak("Let me repeat the job.", () => {
          const utterance = new SpeechSynthesisUtterance(
            `Pickup at ${currentJob.pubName}. Customer: ${currentJob.customerName || 'name not given'}. Phone: ${currentJob.customerPhone || 'not provided'}`
          );
          utterance.lang = 'en-GB';
          utterance.rate = 0.9;
          utterance.onend = () => {
            voiceAttemptCount = 0;
            setTimeout(promptForVoiceResponse, TTS_TO_MIC_DELAY_MS);
          };
          speechSynthesis.speak(utterance);
        });
      }
    }

    // ===== PASSENGER PRESETS =====
    function handlePassengerPreset(data) {
      const msg = 
        data.presetType === "where_are_you" ? "Passenger asks: Where are you?" :
        data.presetType === "cancel_ride" ? "Passenger wants to cancel the ride." :
        data.presetType === "call_driver" ? "Passenger is trying to call you." :
        `Passenger message: ${data.presetType}`;
      speak(msg);
      showPassengerPopup(msg, data);
    }

    function showPassengerPopup(msg, data) {
      document.getElementById('passengerPopupMsg').textContent = msg;
      document.getElementById('passengerPopup').style.display = 'block';
      setTimeout(() => { document.getElementById('passengerPopup').style.display = 'none'; }, 15000);
      document.getElementById('presetReply1').onclick = () => sendPresetReply('on_my_way', data);
      document.getElementById('presetReply2').onclick = () => sendPresetReply('arrived', data);
    }

    function sendPresetReply(type, data) {
      if (!mqttClient) return;
      mqttClient.publish('server/preset_replies', JSON.stringify({
        type: 'driver_preset_reply',
        replyType: type,
        driverId: DRIVER_ID,
        jobId: data?.jobId,
        timestamp: Date.now()
      }));
      document.getElementById('passengerPopup').style.display = 'none';
    }

    // ===== MAP & GPS =====
    function initMap() {
      map = L.map('map').setView([52.4068, -1.5197], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      driverMarker = L.marker([52.4068, -1.5197], { icon: createTaxiIcon() }).addTo(map);
      initGPS();
    }

    function initGPS() {
      if (!navigator.geolocation) {
        document.getElementById('statusBarText').textContent = 'GPS not supported';
        connectMQTT();
        return;
      }
      navigator.geolocation.watchPosition(
        (pos) => {
          currentLocation = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
            accuracy: pos.coords.accuracy || 50
          };
          driverMarker.setLatLng([currentLocation.lat, currentLocation.lng]);
          document.getElementById('statusBarText').textContent = 
            `GPS Active (${Math.round(currentLocation.accuracy)}m)`;
          if (mqttClient && mqttClient.connected) {
            publishLocation();
          }
        },
        (err) => {
          document.getElementById('statusBarText').textContent = 'GPS Error: ' + err.message;
        },
        { enableHighAccuracy: true, maximumAge: 0, timeout: 8000 }
      );
      connectMQTT();
    }

    // ===== MQTT =====
    function connectMQTT() {
      mqttClient = mqtt.connect('wss://broker.hivemq.com:8884/mqtt', { reconnectPeriod: 1000 });
      mqttClient.on('connect', () => {
        mqttClient.subscribe('chat/group');
        mqttClient.subscribe(`chat/private/${DRIVER_ID}/#`);
        mqttClient.subscribe('pubs/requests/#');
        mqttClient.subscribe(`drivers/${DRIVER_ID}/presets`);
        mqttClient.subscribe('drivers/tokens');
        publishStatus();
        if (currentLocation) publishLocation();
        if (fcmToken) publishFcmToken();
      });
      mqttClient.on('message', (topic, payload) => {
        try {
          const data = JSON.parse(payload.toString());
          if (topic === `drivers/${DRIVER_ID}/presets`) {
            handlePassengerPreset(data);
          } else if (topic === 'chat/group' && data.sender !== DRIVER_ID) {
            addChatMessage(data.sender, data.text, data.timestamp, false);
          } else if (topic.startsWith('pubs/requests/')) {
            handleJobRequest(data);
          }
        } catch (e) {
          console.error('MQTT parse error:', e);
        }
      });
    }

    function publishLocation() {
      if (!mqttClient || !currentLocation) return;
      mqttClient.publish(`drivers/${DRIVER_ID}/location`, JSON.stringify({
        driver: DRIVER_ID,
        lat: currentLocation.lat,
        lng: currentLocation.lng,
        status: driverStatus,
        ts: Date.now()
      }));
    }

    function publishStatus() {
      if (!mqttClient) return;
      mqttClient.publish(`drivers/${DRIVER_ID}/status`, JSON.stringify({
        driver: DRIVER_ID,
        status: driverStatus,
        ts: Date.now()
      }));
    }

    // ===== FCM =====
    async function requestFCMToken() {
      try {
        const perm = await Notification.requestPermission();
        if (perm !== 'granted') return;
        const reg = await navigator.serviceWorker.register('/blackcabunite/firebase-messaging-sw.js', { scope: '/blackcabunite/' });
        fcmToken = await messaging.getToken({
          vapidKey: "BMl7GKaqVFHFCn3hkjtrgguYUIM87Hfqd4bbN5lzBiWSjUjEFC8ToIi947P3GqyYnZmaHOJtVjwRHcUcCmuLbow",
          serviceWorkerRegistration: reg
        });
        if (fcmToken && mqttClient?.connected) publishFcmToken();
      } catch (err) {
        console.error('FCM error:', err);
      }
    }

    function publishFcmToken() {
      mqttClient.publish('drivers/tokens', JSON.stringify({
        driverId: DRIVER_ID,
        fcmToken: fcmToken,
        ts: Date.now()
      }));
    }

    // ===== STATUS =====
    function setStatus(status) {
      driverStatus = status;
      localStorage.setItem('driver_status', status);
      const statusText = document.getElementById('statusText');
      statusText.className = 'status-' + status;
      statusText.innerHTML = `<span class="status-dot"></span>${status.charAt(0).toUpperCase() + status.slice(1)}`;
      publishStatus();
      document.getElementById('statusDropdown').style.display = 'none';
    }

    // ===== CHAT =====
    function addChatMessage(from, text, timestamp, isSent) {
      const messages = document.getElementById('chatMessages');
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message ' + (isSent ? 'sent' : 'received');
      const time = new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      msgDiv.innerHTML = `
        ${!isSent ? `<div class="message-sender">${from}</div>` : ''}
        <div>${text}</div>
        <div class="message-time">${time}</div>
      `;
      messages.appendChild(msgDiv);
      messages.scrollTop = messages.scrollHeight;
      const saved = JSON.parse(localStorage.getItem(`chat_${DRIVER_ID}`) || '[]');
      saved.push({ from, text, timestamp, isSent });
      localStorage.setItem(`chat_${DRIVER_ID}`, JSON.stringify(saved));
    }

    function loadChatHistory() {
      const saved = JSON.parse(localStorage.getItem(`chat_${DRIVER_ID}`) || '[]');
      saved.forEach(msg => {
        addChatMessage(msg.from, msg.text, msg.timestamp, msg.isSent);
      });
    }

    function sendMessage() {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      if (!text || !mqttClient) return;
      mqttClient.publish('chat/group', JSON.stringify({
        sender: DRIVER_ID,
        text: text,
        timestamp: Date.now()
      }));
      addChatMessage(DRIVER_ID, text, Date.now(), true);
      input.value = '';
    }

    // ===== JOBS =====
    function handleJobRequest(job) {
      if (driverStatus !== 'available') return;
      const history = JSON.parse(localStorage.getItem(`job_history_${DRIVER_ID}`) || '[]');
      const exists = history.some(h => h.job === job.job);
      if (exists) return;
      history.unshift({ ...job, status: 'queued', timestamp: Date.now() });
      localStorage.setItem(`job_history_${DRIVER_ID}`, JSON.stringify(history));
      displayJob(job);
    }

    function displayJob(job) {
      currentJob = job;
      document.getElementById('jobPickup').textContent = `${job.pubName} (${job.lat.toFixed(5)}, ${job.lng.toFixed(5)})`;
      document.getElementById('jobCustomer').textContent = job.customerName || 'Not provided';
      document.getElementById('jobPhone').textContent = job.customerPhone || 'Not provided';
      document.getElementById('jobPanel').style.display = 'block';
      document.getElementById('jobTimer').style.display = 'block';
      let timeLeft = 30;
      document.getElementById('timerSeconds').textContent = timeLeft;
      jobTimer = setInterval(() => {
        timeLeft--;
        document.getElementById('timerSeconds').textContent = timeLeft;
        if (timeLeft <= 0) {
          clearInterval(jobTimer);
          document.getElementById('jobPanel').style.display = 'none';
          currentJob = null;
        }
      }, 1000);
      speak(`New job! Pickup at ${job.pubName}. Customer: ${job.customerName || 'name not given'}`, () => {
        promptForVoiceResponse();
      });
    }

    function respondToJob(accepted) {
      if (!currentJob || !mqttClient) return;
      mqttClient.publish(`jobs/${currentJob.job}/status`, JSON.stringify({
        job: currentJob.job,
        driver: DRIVER_ID,
        status: accepted ? "bidding" : "rejected",
        lat: currentLocation?.lat || currentJob.lat,
        lng: currentLocation?.lng || currentJob.lng,
        ts: Date.now()
      }));
      clearInterval(jobTimer);
      document.getElementById('jobPanel').style.display = 'none';
      stopVoiceListener();
      speechSynthesis.cancel();
      const history = JSON.parse(localStorage.getItem(`job_history_${DRIVER_ID}`) || '[]');
      const jobIndex = history.findIndex(j => j.job === currentJob.job);
      if (jobIndex >= 0) {
        history[jobIndex].status = accepted ? 'bidding' : 'rejected';
        localStorage.setItem(`job_history_${DRIVER_ID}`, JSON.stringify(history));
      }
      currentJob = null;
      loadJobHistory();
    }

    function loadJobHistory() {
      const history = JSON.parse(localStorage.getItem(`job_history_${DRIVER_ID}`) || '[]');
      const list = document.getElementById('historyList');
      if (history.length === 0) {
        list.innerHTML = `<div class="empty-state"><div class="empty-icon">üìã</div><div>No job history yet</div></div>`;
        return;
      }
      list.innerHTML = history.map((job, i) => `
        <div class="job-item">
          <div class="job-header">
            <div class="job-id">Job ${job.job}</div>
            <div class="job-badge badge-${job.status}">${job.status}</div>
          </div>
          <div>Pub: ${job.pubName}</div>
          <div>Customer: ${job.customerName || '‚Äî'}</div>
          <div>Phone: ${job.customerPhone}</div>
          <div style="font-size:12px; color:#666; margin-top:8px;">
            ${new Date(job.timestamp).toLocaleString()}
          </div>
        </div>
      `).join('');
    }

    // ===== EVENT LISTENERS =====
    document.getElementById('appTitle').addEventListener('click', (e) => {
      e.stopPropagation();
      document.getElementById('statusDropdown').style.display = 
        document.getElementById('statusDropdown').style.display === 'none' ? 'block' : 'none';
    });
    document.querySelectorAll('.status-option').forEach(opt => {
      opt.addEventListener('click', () => setStatus(opt.dataset.status));
    });
    document.getElementById('menuBtn').addEventListener('click', () => {
      document.getElementById('menuPanel').classList.toggle('active');
    });
    document.querySelectorAll('.menu-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.menu-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.menu-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + 'View').classList.add('active');
      });
    });
    document.getElementById('sendBtn').addEventListener('click', sendMessage);
    document.getElementById('messageInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
    document.getElementById('acceptBtn').addEventListener('click', () => respondToJob(true));
    document.getElementById('rejectBtn').addEventListener('click', () => respondToJob(false));
    document.getElementById('saveSettings').addEventListener('click', () => {
      const name = document.getElementById('driverName').value;
      const phone = document.getElementById('driverPhone').value;
      localStorage.setItem(`driver_name_${DRIVER_ID}`, name);
      localStorage.setItem(`driver_phone_${DRIVER_ID}`, phone);
      alert('Settings saved!');
    });
    document.getElementById('clearHistory').addEventListener('click', () => {
      if (confirm('Clear all history?')) {
        localStorage.removeItem(`job_history_${DRIVER_ID}`);
        localStorage.removeItem(`chat_${DRIVER_ID}`);
        document.getElementById('chatMessages').innerHTML = '';
        loadJobHistory();
        alert('History cleared!');
      }
    });
    document.addEventListener('click', (e) => {
      if (!e.target.closest('#appTitle') && !e.target.closest('#statusDropdown')) {
        document.getElementById('statusDropdown').style.display = 'none';
      }
    });

    // ===== INIT =====
    document.getElementById('driverName').value = localStorage.getItem(`driver_name_${DRIVER_ID}`) || '';
    document.getElementById('driverPhone').value = localStorage.getItem(`driver_phone_${DRIVER_ID}`) || '';
    initMap();
    if ('serviceWorker' in navigator) requestFCMToken();
    loadChatHistory();
    loadJobHistory();
    setStatus(driverStatus);
  </script>
</body>
</html>
